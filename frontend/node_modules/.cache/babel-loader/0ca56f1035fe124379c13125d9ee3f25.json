{"ast":null,"code":"import { EventEmitter } from \"events\";\nimport { safeJsonParse, safeJsonStringify } from \"@walletconnect/safe-json\";\nimport { formatJsonRpcError, isReactNative, isWsUrl, isLocalhostUrl, parseConnectionError } from \"@walletconnect/jsonrpc-utils\";\nconst EVENT_EMITTER_MAX_LISTENERS_DEFAULT = 10;\n\nconst resolveWebSocketImplementation = () => {\n  if (typeof global !== \"undefined\" && typeof global.WebSocket !== \"undefined\") {\n    return global.WebSocket;\n  }\n\n  if (typeof window !== \"undefined\" && typeof window.WebSocket !== \"undefined\") {\n    return window.WebSocket;\n  }\n\n  return require(\"ws\");\n};\n\nconst isBrowser = () => typeof window !== \"undefined\";\n\nconst WS = resolveWebSocketImplementation();\nexport class WsConnection {\n  constructor(url) {\n    this.url = url;\n    this.events = new EventEmitter();\n    this.registering = false;\n\n    if (!isWsUrl(url)) {\n      throw new Error(`Provided URL is not compatible with WebSocket connection: ${url}`);\n    }\n\n    this.url = url;\n  }\n\n  get connected() {\n    return typeof this.socket !== \"undefined\";\n  }\n\n  get connecting() {\n    return this.registering;\n  }\n\n  on(event, listener) {\n    this.events.on(event, listener);\n  }\n\n  once(event, listener) {\n    this.events.once(event, listener);\n  }\n\n  off(event, listener) {\n    this.events.off(event, listener);\n  }\n\n  removeListener(event, listener) {\n    this.events.removeListener(event, listener);\n  }\n\n  async open() {\n    let url = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.url;\n    await this.register(url);\n  }\n\n  async close() {\n    return new Promise((resolve, reject) => {\n      if (typeof this.socket === \"undefined\") {\n        reject(new Error(\"Connection already closed\"));\n        return;\n      }\n\n      this.socket.onclose = () => {\n        this.onClose();\n        resolve();\n      };\n\n      this.socket.close();\n    });\n  }\n\n  async send(payload, context) {\n    if (typeof this.socket === \"undefined\") {\n      this.socket = await this.register();\n    }\n\n    try {\n      this.socket.send(safeJsonStringify(payload));\n    } catch (e) {\n      this.onError(payload.id, e);\n    }\n  }\n\n  register() {\n    let url = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.url;\n\n    if (!isWsUrl(url)) {\n      throw new Error(`Provided URL is not compatible with WebSocket connection: ${url}`);\n    }\n\n    if (this.registering) {\n      const currentMaxListeners = this.events.getMaxListeners();\n\n      if (this.events.listenerCount(\"register_error\") >= currentMaxListeners || this.events.listenerCount(\"open\") >= currentMaxListeners) {\n        this.events.setMaxListeners(currentMaxListeners + 1);\n      }\n\n      return new Promise((resolve, reject) => {\n        this.events.once(\"register_error\", error => {\n          this.resetMaxListeners();\n          reject(error);\n        });\n        this.events.once(\"open\", () => {\n          this.resetMaxListeners();\n\n          if (typeof this.socket === \"undefined\") {\n            return reject(new Error(\"WebSocket connection is missing or invalid\"));\n          }\n\n          resolve(this.socket);\n        });\n      });\n    }\n\n    this.url = url;\n    this.registering = true;\n    return new Promise((resolve, reject) => {\n      const opts = !isReactNative() ? {\n        rejectUnauthorized: !isLocalhostUrl(url)\n      } : undefined;\n      const socket = new WS(url, [], opts);\n\n      if (isBrowser()) {\n        socket.onerror = event => {\n          const errorEvent = event;\n          reject(this.emitError(errorEvent.error));\n        };\n      } else {\n        socket.on(\"error\", errorEvent => {\n          reject(this.emitError(errorEvent));\n        });\n      }\n\n      socket.onopen = () => {\n        this.onOpen(socket);\n        resolve(socket);\n      };\n    });\n  }\n\n  onOpen(socket) {\n    socket.onmessage = event => this.onPayload(event);\n\n    socket.onclose = () => this.onClose();\n\n    this.socket = socket;\n    this.registering = false;\n    this.events.emit(\"open\");\n  }\n\n  onClose() {\n    this.socket = undefined;\n    this.registering = false;\n    this.events.emit(\"close\");\n  }\n\n  onPayload(e) {\n    if (typeof e.data === \"undefined\") return;\n    const payload = typeof e.data === \"string\" ? safeJsonParse(e.data) : e.data;\n    this.events.emit(\"payload\", payload);\n  }\n\n  onError(id, e) {\n    const error = this.parseError(e);\n    const message = error.message || error.toString();\n    const payload = formatJsonRpcError(id, message);\n    this.events.emit(\"payload\", payload);\n  }\n\n  parseError(e) {\n    let url = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.url;\n    return parseConnectionError(e, url, \"WS\");\n  }\n\n  resetMaxListeners() {\n    if (this.events.getMaxListeners() > EVENT_EMITTER_MAX_LISTENERS_DEFAULT) {\n      this.events.setMaxListeners(EVENT_EMITTER_MAX_LISTENERS_DEFAULT);\n    }\n  }\n\n  emitError(errorEvent) {\n    const error = this.parseError(new Error((errorEvent === null || errorEvent === void 0 ? void 0 : errorEvent.message) || `WebSocket connection failed for URL: ${this.url}`));\n    this.events.emit(\"register_error\", error);\n    return error;\n  }\n\n}\nexport default WsConnection;","map":{"version":3,"mappings":"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","names":["EventEmitter","safeJsonParse","safeJsonStringify","formatJsonRpcError","isReactNative","isWsUrl","isLocalhostUrl","parseConnectionError","EVENT_EMITTER_MAX_LISTENERS_DEFAULT","resolveWebSocketImplementation","global","WebSocket","window","require","isBrowser","WS","WsConnection","constructor","url","Error","connected","socket","connecting","registering","on","event","listener","events","once","off","removeListener","open","register","close","Promise","resolve","reject","onclose","onClose","send","payload","context","e","onError","id","currentMaxListeners","getMaxListeners","listenerCount","setMaxListeners","error","resetMaxListeners","opts","rejectUnauthorized","undefined","onerror","errorEvent","emitError","onopen","onOpen","onmessage","onPayload","emit","data","parseError","message","toString"],"sources":["../../src/ws.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}