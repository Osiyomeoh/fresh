{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.JsonRpcEngine = void 0;\n\nconst safe_event_emitter_1 = __importDefault(require(\"@metamask/safe-event-emitter\"));\n\nconst eth_rpc_errors_1 = require(\"eth-rpc-errors\");\n/**\n * A JSON-RPC request and response processor.\n * Give it a stack of middleware, pass it requests, and get back responses.\n */\n\n\nclass JsonRpcEngine extends safe_event_emitter_1.default {\n  constructor() {\n    super();\n    this._middleware = [];\n  }\n  /**\n   * Add a middleware function to the engine's middleware stack.\n   *\n   * @param middleware - The middleware function to add.\n   */\n\n\n  push(middleware) {\n    this._middleware.push(middleware);\n  }\n\n  handle(req, cb) {\n    if (cb && typeof cb !== 'function') {\n      throw new Error('\"callback\" must be a function if provided.');\n    }\n\n    if (Array.isArray(req)) {\n      if (cb) {\n        return this._handleBatch(req, cb);\n      }\n\n      return this._handleBatch(req);\n    }\n\n    if (cb) {\n      return this._handle(req, cb);\n    }\n\n    return this._promiseHandle(req);\n  }\n  /**\n   * Returns this engine as a middleware function that can be pushed to other\n   * engines.\n   *\n   * @returns This engine as a middleware function.\n   */\n\n\n  asMiddleware() {\n    return async (req, res, next, end) => {\n      try {\n        const [middlewareError, isComplete, returnHandlers] = await JsonRpcEngine._runAllMiddleware(req, res, this._middleware);\n\n        if (isComplete) {\n          await JsonRpcEngine._runReturnHandlers(returnHandlers);\n          return end(middlewareError);\n        }\n\n        return next(async handlerCallback => {\n          try {\n            await JsonRpcEngine._runReturnHandlers(returnHandlers);\n          } catch (error) {\n            return handlerCallback(error);\n          }\n\n          return handlerCallback();\n        });\n      } catch (error) {\n        return end(error);\n      }\n    };\n  }\n\n  async _handleBatch(reqs, cb) {\n    // The order here is important\n    try {\n      // 2. Wait for all requests to finish, or throw on some kind of fatal\n      // error\n      const responses = await Promise.all( // 1. Begin executing each request in the order received\n      reqs.map(this._promiseHandle.bind(this))); // 3. Return batch response\n\n      if (cb) {\n        return cb(null, responses);\n      }\n\n      return responses;\n    } catch (error) {\n      if (cb) {\n        return cb(error);\n      }\n\n      throw error;\n    }\n  }\n  /**\n   * A promise-wrapped _handle.\n   */\n\n\n  _promiseHandle(req) {\n    return new Promise(resolve => {\n      this._handle(req, (_err, res) => {\n        // There will always be a response, and it will always have any error\n        // that is caught and propagated.\n        resolve(res);\n      });\n    });\n  }\n  /**\n   * Ensures that the request object is valid, processes it, and passes any\n   * error and the response object to the given callback.\n   *\n   * Does not reject.\n   */\n\n\n  async _handle(callerReq, cb) {\n    if (!callerReq || Array.isArray(callerReq) || typeof callerReq !== 'object') {\n      const error = new eth_rpc_errors_1.EthereumRpcError(eth_rpc_errors_1.errorCodes.rpc.invalidRequest, `Requests must be plain objects. Received: ${typeof callerReq}`, {\n        request: callerReq\n      });\n      return cb(error, {\n        id: undefined,\n        jsonrpc: '2.0',\n        error\n      });\n    }\n\n    if (typeof callerReq.method !== 'string') {\n      const error = new eth_rpc_errors_1.EthereumRpcError(eth_rpc_errors_1.errorCodes.rpc.invalidRequest, `Must specify a string method. Received: ${typeof callerReq.method}`, {\n        request: callerReq\n      });\n      return cb(error, {\n        id: callerReq.id,\n        jsonrpc: '2.0',\n        error\n      });\n    }\n\n    const req = Object.assign({}, callerReq);\n    const res = {\n      id: req.id,\n      jsonrpc: req.jsonrpc\n    };\n    let error = null;\n\n    try {\n      await this._processRequest(req, res);\n    } catch (_error) {\n      // A request handler error, a re-thrown middleware error, or something\n      // unexpected.\n      error = _error;\n    }\n\n    if (error) {\n      // Ensure no result is present on an errored response\n      delete res.result;\n\n      if (!res.error) {\n        res.error = eth_rpc_errors_1.serializeError(error);\n      }\n    }\n\n    return cb(error, res);\n  }\n  /**\n   * For the given request and response, runs all middleware and their return\n   * handlers, if any, and ensures that internal request processing semantics\n   * are satisfied.\n   */\n\n\n  async _processRequest(req, res) {\n    const [error, isComplete, returnHandlers] = await JsonRpcEngine._runAllMiddleware(req, res, this._middleware); // Throw if \"end\" was not called, or if the response has neither a result\n    // nor an error.\n\n    JsonRpcEngine._checkForCompletion(req, res, isComplete); // The return handlers should run even if an error was encountered during\n    // middleware processing.\n\n\n    await JsonRpcEngine._runReturnHandlers(returnHandlers); // Now we re-throw the middleware processing error, if any, to catch it\n    // further up the call chain.\n\n    if (error) {\n      throw error;\n    }\n  }\n  /**\n   * Serially executes the given stack of middleware.\n   *\n   * @returns An array of any error encountered during middleware execution,\n   * a boolean indicating whether the request was completed, and an array of\n   * middleware-defined return handlers.\n   */\n\n\n  static async _runAllMiddleware(req, res, middlewareStack) {\n    const returnHandlers = [];\n    let error = null;\n    let isComplete = false; // Go down stack of middleware, call and collect optional returnHandlers\n\n    for (const middleware of middlewareStack) {\n      [error, isComplete] = await JsonRpcEngine._runMiddleware(req, res, middleware, returnHandlers);\n\n      if (isComplete) {\n        break;\n      }\n    }\n\n    return [error, isComplete, returnHandlers.reverse()];\n  }\n  /**\n   * Runs an individual middleware.\n   *\n   * @returns An array of any error encountered during middleware exection,\n   * and a boolean indicating whether the request should end.\n   */\n\n\n  static _runMiddleware(req, res, middleware, returnHandlers) {\n    return new Promise(resolve => {\n      const end = err => {\n        const error = err || res.error;\n\n        if (error) {\n          res.error = eth_rpc_errors_1.serializeError(error);\n        } // True indicates that the request should end\n\n\n        resolve([error, true]);\n      };\n\n      const next = returnHandler => {\n        if (res.error) {\n          end(res.error);\n        } else {\n          if (returnHandler) {\n            if (typeof returnHandler !== 'function') {\n              end(new eth_rpc_errors_1.EthereumRpcError(eth_rpc_errors_1.errorCodes.rpc.internal, `JsonRpcEngine: \"next\" return handlers must be functions. ` + `Received \"${typeof returnHandler}\" for request:\\n${jsonify(req)}`, {\n                request: req\n              }));\n            }\n\n            returnHandlers.push(returnHandler);\n          } // False indicates that the request should not end\n\n\n          resolve([null, false]);\n        }\n      };\n\n      try {\n        middleware(req, res, next, end);\n      } catch (error) {\n        end(error);\n      }\n    });\n  }\n  /**\n   * Serially executes array of return handlers. The request and response are\n   * assumed to be in their scope.\n   */\n\n\n  static async _runReturnHandlers(handlers) {\n    for (const handler of handlers) {\n      await new Promise((resolve, reject) => {\n        handler(err => err ? reject(err) : resolve());\n      });\n    }\n  }\n  /**\n   * Throws an error if the response has neither a result nor an error, or if\n   * the \"isComplete\" flag is falsy.\n   */\n\n\n  static _checkForCompletion(req, res, isComplete) {\n    if (!('result' in res) && !('error' in res)) {\n      throw new eth_rpc_errors_1.EthereumRpcError(eth_rpc_errors_1.errorCodes.rpc.internal, `JsonRpcEngine: Response has no error or result for request:\\n${jsonify(req)}`, {\n        request: req\n      });\n    }\n\n    if (!isComplete) {\n      throw new eth_rpc_errors_1.EthereumRpcError(eth_rpc_errors_1.errorCodes.rpc.internal, `JsonRpcEngine: Nothing ended request:\\n${jsonify(req)}`, {\n        request: req\n      });\n    }\n  }\n\n}\n\nexports.JsonRpcEngine = JsonRpcEngine;\n\nfunction jsonify(request) {\n  return JSON.stringify(request, null, 2);\n}","map":{"version":3,"mappings":"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","names":["JsonRpcEngine","safe_event_emitter_1","constructor","_middleware","push","middleware","handle","req","cb","Error","Array","isArray","_handleBatch","_handle","_promiseHandle","asMiddleware","res","next","end","middlewareError","isComplete","returnHandlers","_runAllMiddleware","_runReturnHandlers","handlerCallback","error","reqs","responses","Promise","all","map","bind","resolve","_err","callerReq","eth_rpc_errors_1","rpc","invalidRequest","request","id","undefined","jsonrpc","method","_processRequest","_error","result","_checkForCompletion","middlewareStack","_runMiddleware","reverse","err","returnHandler","internal","jsonify","handlers","handler","reject","exports","JSON","stringify"],"sources":["../src/JsonRpcEngine.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}