{"ast":null,"code":"const SafeEventEmitter = require('@metamask/safe-event-emitter').default;\n\nconst createScaffoldMiddleware = require('eth-json-rpc-middleware/scaffold');\n\nconst {\n  createAsyncMiddleware\n} = require('json-rpc-engine');\n\nconst createFilterMiddleware = require('./index.js');\n\nconst {\n  unsafeRandomBytes,\n  incrementHexInt\n} = require('./hexUtils.js');\n\nconst getBlocksForRange = require('./getBlocksForRange.js');\n\nmodule.exports = createSubscriptionMiddleware;\n\nfunction createSubscriptionMiddleware(_ref) {\n  let {\n    blockTracker,\n    provider\n  } = _ref;\n  // state and utilities for handling subscriptions\n  const subscriptions = {};\n  const filterManager = createFilterMiddleware({\n    blockTracker,\n    provider\n  }); // internal flag\n\n  let isDestroyed = false; // create subscriptionManager api object\n\n  const events = new SafeEventEmitter();\n  const middleware = createScaffoldMiddleware({\n    eth_subscribe: createAsyncMiddleware(subscribe),\n    eth_unsubscribe: createAsyncMiddleware(unsubscribe)\n  });\n  middleware.destroy = destroy;\n  return {\n    events,\n    middleware\n  };\n\n  async function subscribe(req, res) {\n    if (isDestroyed) throw new Error('SubscriptionManager - attempting to use after destroying');\n    const subscriptionType = req.params[0]; // subId is 16 byte hex string\n\n    const subId = unsafeRandomBytes(16); // create sub\n\n    let sub;\n\n    switch (subscriptionType) {\n      case 'newHeads':\n        sub = createSubNewHeads({\n          subId\n        });\n        break;\n\n      case 'logs':\n        const filterParams = req.params[1];\n        const filter = await filterManager.newLogFilter(filterParams);\n        sub = createSubFromFilter({\n          subId,\n          filter\n        });\n        break;\n\n      default:\n        throw new Error(`SubscriptionManager - unsupported subscription type \"${subscriptionType}\"`);\n    }\n\n    subscriptions[subId] = sub;\n    res.result = subId;\n    return;\n\n    function createSubNewHeads(_ref2) {\n      let {\n        subId\n      } = _ref2;\n      const sub = {\n        type: subscriptionType,\n        destroy: async () => {\n          blockTracker.removeListener('sync', sub.update);\n        },\n        update: async _ref3 => {\n          let {\n            oldBlock,\n            newBlock\n          } = _ref3;\n          // for newHeads\n          const toBlock = newBlock;\n          const fromBlock = incrementHexInt(oldBlock);\n          const rawBlocks = await getBlocksForRange({\n            provider,\n            fromBlock,\n            toBlock\n          });\n          const results = rawBlocks.map(normalizeBlock);\n          results.forEach(value => {\n            _emitSubscriptionResult(subId, value);\n          });\n        }\n      }; // check for subscription updates on new block\n\n      blockTracker.on('sync', sub.update);\n      return sub;\n    }\n\n    function createSubFromFilter(_ref4) {\n      let {\n        subId,\n        filter\n      } = _ref4;\n      filter.on('update', result => _emitSubscriptionResult(subId, result));\n      const sub = {\n        type: subscriptionType,\n        destroy: async () => {\n          return await filterManager.uninstallFilter(filter.idHex);\n        }\n      };\n      return sub;\n    }\n  }\n\n  async function unsubscribe(req, res) {\n    if (isDestroyed) throw new Error('SubscriptionManager - attempting to use after destroying');\n    const id = req.params[0];\n    const subscription = subscriptions[id]; // if missing, return \"false\" to indicate it was not removed\n\n    if (!subscription) {\n      res.result = false;\n      return;\n    } // cleanup subscription\n\n\n    delete subscriptions[id];\n    await subscription.destroy();\n    res.result = true;\n  }\n\n  function _emitSubscriptionResult(filterIdHex, value) {\n    events.emit('notification', {\n      jsonrpc: '2.0',\n      method: 'eth_subscription',\n      params: {\n        subscription: filterIdHex,\n        result: value\n      }\n    });\n  }\n\n  function destroy() {\n    events.removeAllListeners();\n\n    for (const id in subscriptions) {\n      subscriptions[id].destroy();\n      delete subscriptions[id];\n    }\n\n    isDestroyed = true;\n  }\n}\n\nfunction normalizeBlock(block) {\n  return {\n    hash: block.hash,\n    parentHash: block.parentHash,\n    sha3Uncles: block.sha3Uncles,\n    miner: block.miner,\n    stateRoot: block.stateRoot,\n    transactionsRoot: block.transactionsRoot,\n    receiptsRoot: block.receiptsRoot,\n    logsBloom: block.logsBloom,\n    difficulty: block.difficulty,\n    number: block.number,\n    gasLimit: block.gasLimit,\n    gasUsed: block.gasUsed,\n    nonce: block.nonce,\n    mixHash: block.mixHash,\n    timestamp: block.timestamp,\n    extraData: block.extraData\n  };\n}","map":{"version":3,"names":["SafeEventEmitter","require","default","createScaffoldMiddleware","createAsyncMiddleware","createFilterMiddleware","unsafeRandomBytes","incrementHexInt","getBlocksForRange","module","exports","createSubscriptionMiddleware","blockTracker","provider","subscriptions","filterManager","isDestroyed","events","middleware","eth_subscribe","subscribe","eth_unsubscribe","unsubscribe","destroy","req","res","Error","subscriptionType","params","subId","sub","createSubNewHeads","filterParams","filter","newLogFilter","createSubFromFilter","result","type","removeListener","update","oldBlock","newBlock","toBlock","fromBlock","rawBlocks","results","map","normalizeBlock","forEach","value","_emitSubscriptionResult","on","uninstallFilter","idHex","id","subscription","filterIdHex","emit","jsonrpc","method","removeAllListeners","block","hash","parentHash","sha3Uncles","miner","stateRoot","transactionsRoot","receiptsRoot","logsBloom","difficulty","number","gasLimit","gasUsed","nonce","mixHash","timestamp","extraData"],"sources":["C:/Users/USER/Documents/demo-react/node_modules/eth-json-rpc-filters/subscriptionManager.js"],"sourcesContent":["const SafeEventEmitter = require('@metamask/safe-event-emitter').default\nconst createScaffoldMiddleware = require('eth-json-rpc-middleware/scaffold')\nconst { createAsyncMiddleware } = require('json-rpc-engine')\nconst createFilterMiddleware = require('./index.js')\nconst { unsafeRandomBytes, incrementHexInt } = require('./hexUtils.js')\nconst getBlocksForRange = require('./getBlocksForRange.js')\n\nmodule.exports = createSubscriptionMiddleware\n\n\nfunction createSubscriptionMiddleware({ blockTracker, provider }) {\n  // state and utilities for handling subscriptions\n  const subscriptions = {}\n  const filterManager = createFilterMiddleware({ blockTracker, provider })\n\n  // internal flag\n  let isDestroyed = false\n\n  // create subscriptionManager api object\n  const events = new SafeEventEmitter()\n  const middleware = createScaffoldMiddleware({\n    eth_subscribe: createAsyncMiddleware(subscribe),\n    eth_unsubscribe: createAsyncMiddleware(unsubscribe),\n  })\n  middleware.destroy = destroy\n  return { events, middleware }\n\n  async function subscribe(req, res) {\n\n    if (isDestroyed) throw new Error(\n      'SubscriptionManager - attempting to use after destroying'\n    )\n\n    const subscriptionType = req.params[0]\n    // subId is 16 byte hex string\n    const subId = unsafeRandomBytes(16)\n\n    // create sub\n    let sub\n    switch (subscriptionType) {\n      case 'newHeads':\n        sub = createSubNewHeads({ subId })\n        break\n      case 'logs':\n        const filterParams = req.params[1]\n        const filter = await filterManager.newLogFilter(filterParams)\n        sub = createSubFromFilter({ subId, filter })\n        break\n      default:\n        throw new Error(`SubscriptionManager - unsupported subscription type \"${subscriptionType}\"`)\n\n    }\n    subscriptions[subId] = sub\n\n    res.result = subId\n    return\n\n    function createSubNewHeads({ subId }) {\n      const sub = {\n        type: subscriptionType,\n        destroy: async () => {\n          blockTracker.removeListener('sync', sub.update)\n        },\n        update: async ({ oldBlock, newBlock }) => {\n          // for newHeads\n          const toBlock = newBlock\n          const fromBlock = incrementHexInt(oldBlock)\n          const rawBlocks = await getBlocksForRange({ provider, fromBlock, toBlock })\n          const results = rawBlocks.map(normalizeBlock)\n          results.forEach((value) => {\n            _emitSubscriptionResult(subId, value)\n          })\n        }\n      }\n      // check for subscription updates on new block\n      blockTracker.on('sync', sub.update)\n      return sub\n    }\n\n    function createSubFromFilter({ subId, filter }){\n      filter.on('update', result => _emitSubscriptionResult(subId, result))\n      const sub = {\n        type: subscriptionType,\n        destroy: async () => {\n          return await filterManager.uninstallFilter(filter.idHex)\n        },\n      }\n      return sub\n    }\n  }\n\n  async function unsubscribe(req, res) {\n\n    if (isDestroyed) throw new Error(\n      'SubscriptionManager - attempting to use after destroying'\n    )\n\n    const id = req.params[0]\n    const subscription = subscriptions[id]\n    // if missing, return \"false\" to indicate it was not removed\n    if (!subscription) {\n      res.result = false\n      return\n    }\n    // cleanup subscription\n    delete subscriptions[id]\n    await subscription.destroy()\n    res.result = true\n  }\n\n  function _emitSubscriptionResult(filterIdHex, value) {\n    events.emit('notification', {\n      jsonrpc: '2.0',\n      method: 'eth_subscription',\n      params: {\n        subscription: filterIdHex,\n        result: value,\n      },\n    })\n  }\n\n  function destroy () {\n    events.removeAllListeners()\n    for (const id in subscriptions) {\n      subscriptions[id].destroy()\n      delete subscriptions[id]\n    }\n    isDestroyed = true\n  }\n}\n\nfunction normalizeBlock(block) {\n  return {\n    hash: block.hash,\n    parentHash: block.parentHash,\n    sha3Uncles: block.sha3Uncles,\n    miner: block.miner,\n    stateRoot: block.stateRoot,\n    transactionsRoot: block.transactionsRoot,\n    receiptsRoot: block.receiptsRoot,\n    logsBloom: block.logsBloom,\n    difficulty: block.difficulty,\n    number: block.number,\n    gasLimit: block.gasLimit,\n    gasUsed: block.gasUsed,\n    nonce: block.nonce,\n    mixHash: block.mixHash,\n    timestamp: block.timestamp,\n    extraData: block.extraData,\n  }\n}\n"],"mappings":"AAAA,MAAMA,gBAAgB,GAAGC,OAAO,CAAC,8BAAD,CAAP,CAAwCC,OAAjE;;AACA,MAAMC,wBAAwB,GAAGF,OAAO,CAAC,kCAAD,CAAxC;;AACA,MAAM;EAAEG;AAAF,IAA4BH,OAAO,CAAC,iBAAD,CAAzC;;AACA,MAAMI,sBAAsB,GAAGJ,OAAO,CAAC,YAAD,CAAtC;;AACA,MAAM;EAAEK,iBAAF;EAAqBC;AAArB,IAAyCN,OAAO,CAAC,eAAD,CAAtD;;AACA,MAAMO,iBAAiB,GAAGP,OAAO,CAAC,wBAAD,CAAjC;;AAEAQ,MAAM,CAACC,OAAP,GAAiBC,4BAAjB;;AAGA,SAASA,4BAAT,OAAkE;EAAA,IAA5B;IAAEC,YAAF;IAAgBC;EAAhB,CAA4B;EAChE;EACA,MAAMC,aAAa,GAAG,EAAtB;EACA,MAAMC,aAAa,GAAGV,sBAAsB,CAAC;IAAEO,YAAF;IAAgBC;EAAhB,CAAD,CAA5C,CAHgE,CAKhE;;EACA,IAAIG,WAAW,GAAG,KAAlB,CANgE,CAQhE;;EACA,MAAMC,MAAM,GAAG,IAAIjB,gBAAJ,EAAf;EACA,MAAMkB,UAAU,GAAGf,wBAAwB,CAAC;IAC1CgB,aAAa,EAAEf,qBAAqB,CAACgB,SAAD,CADM;IAE1CC,eAAe,EAAEjB,qBAAqB,CAACkB,WAAD;EAFI,CAAD,CAA3C;EAIAJ,UAAU,CAACK,OAAX,GAAqBA,OAArB;EACA,OAAO;IAAEN,MAAF;IAAUC;EAAV,CAAP;;EAEA,eAAeE,SAAf,CAAyBI,GAAzB,EAA8BC,GAA9B,EAAmC;IAEjC,IAAIT,WAAJ,EAAiB,MAAM,IAAIU,KAAJ,CACrB,0DADqB,CAAN;IAIjB,MAAMC,gBAAgB,GAAGH,GAAG,CAACI,MAAJ,CAAW,CAAX,CAAzB,CANiC,CAOjC;;IACA,MAAMC,KAAK,GAAGvB,iBAAiB,CAAC,EAAD,CAA/B,CARiC,CAUjC;;IACA,IAAIwB,GAAJ;;IACA,QAAQH,gBAAR;MACE,KAAK,UAAL;QACEG,GAAG,GAAGC,iBAAiB,CAAC;UAAEF;QAAF,CAAD,CAAvB;QACA;;MACF,KAAK,MAAL;QACE,MAAMG,YAAY,GAAGR,GAAG,CAACI,MAAJ,CAAW,CAAX,CAArB;QACA,MAAMK,MAAM,GAAG,MAAMlB,aAAa,CAACmB,YAAd,CAA2BF,YAA3B,CAArB;QACAF,GAAG,GAAGK,mBAAmB,CAAC;UAAEN,KAAF;UAASI;QAAT,CAAD,CAAzB;QACA;;MACF;QACE,MAAM,IAAIP,KAAJ,CAAW,wDAAuDC,gBAAiB,GAAnF,CAAN;IAVJ;;IAaAb,aAAa,CAACe,KAAD,CAAb,GAAuBC,GAAvB;IAEAL,GAAG,CAACW,MAAJ,GAAaP,KAAb;IACA;;IAEA,SAASE,iBAAT,QAAsC;MAAA,IAAX;QAAEF;MAAF,CAAW;MACpC,MAAMC,GAAG,GAAG;QACVO,IAAI,EAAEV,gBADI;QAEVJ,OAAO,EAAE,YAAY;UACnBX,YAAY,CAAC0B,cAAb,CAA4B,MAA5B,EAAoCR,GAAG,CAACS,MAAxC;QACD,CAJS;QAKVA,MAAM,EAAE,eAAkC;UAAA,IAA3B;YAAEC,QAAF;YAAYC;UAAZ,CAA2B;UACxC;UACA,MAAMC,OAAO,GAAGD,QAAhB;UACA,MAAME,SAAS,GAAGpC,eAAe,CAACiC,QAAD,CAAjC;UACA,MAAMI,SAAS,GAAG,MAAMpC,iBAAiB,CAAC;YAAEK,QAAF;YAAY8B,SAAZ;YAAuBD;UAAvB,CAAD,CAAzC;UACA,MAAMG,OAAO,GAAGD,SAAS,CAACE,GAAV,CAAcC,cAAd,CAAhB;UACAF,OAAO,CAACG,OAAR,CAAiBC,KAAD,IAAW;YACzBC,uBAAuB,CAACrB,KAAD,EAAQoB,KAAR,CAAvB;UACD,CAFD;QAGD;MAdS,CAAZ,CADoC,CAiBpC;;MACArC,YAAY,CAACuC,EAAb,CAAgB,MAAhB,EAAwBrB,GAAG,CAACS,MAA5B;MACA,OAAOT,GAAP;IACD;;IAED,SAASK,mBAAT,QAA+C;MAAA,IAAlB;QAAEN,KAAF;QAASI;MAAT,CAAkB;MAC7CA,MAAM,CAACkB,EAAP,CAAU,QAAV,EAAoBf,MAAM,IAAIc,uBAAuB,CAACrB,KAAD,EAAQO,MAAR,CAArD;MACA,MAAMN,GAAG,GAAG;QACVO,IAAI,EAAEV,gBADI;QAEVJ,OAAO,EAAE,YAAY;UACnB,OAAO,MAAMR,aAAa,CAACqC,eAAd,CAA8BnB,MAAM,CAACoB,KAArC,CAAb;QACD;MAJS,CAAZ;MAMA,OAAOvB,GAAP;IACD;EACF;;EAED,eAAeR,WAAf,CAA2BE,GAA3B,EAAgCC,GAAhC,EAAqC;IAEnC,IAAIT,WAAJ,EAAiB,MAAM,IAAIU,KAAJ,CACrB,0DADqB,CAAN;IAIjB,MAAM4B,EAAE,GAAG9B,GAAG,CAACI,MAAJ,CAAW,CAAX,CAAX;IACA,MAAM2B,YAAY,GAAGzC,aAAa,CAACwC,EAAD,CAAlC,CAPmC,CAQnC;;IACA,IAAI,CAACC,YAAL,EAAmB;MACjB9B,GAAG,CAACW,MAAJ,GAAa,KAAb;MACA;IACD,CAZkC,CAanC;;;IACA,OAAOtB,aAAa,CAACwC,EAAD,CAApB;IACA,MAAMC,YAAY,CAAChC,OAAb,EAAN;IACAE,GAAG,CAACW,MAAJ,GAAa,IAAb;EACD;;EAED,SAASc,uBAAT,CAAiCM,WAAjC,EAA8CP,KAA9C,EAAqD;IACnDhC,MAAM,CAACwC,IAAP,CAAY,cAAZ,EAA4B;MAC1BC,OAAO,EAAE,KADiB;MAE1BC,MAAM,EAAE,kBAFkB;MAG1B/B,MAAM,EAAE;QACN2B,YAAY,EAAEC,WADR;QAENpB,MAAM,EAAEa;MAFF;IAHkB,CAA5B;EAQD;;EAED,SAAS1B,OAAT,GAAoB;IAClBN,MAAM,CAAC2C,kBAAP;;IACA,KAAK,MAAMN,EAAX,IAAiBxC,aAAjB,EAAgC;MAC9BA,aAAa,CAACwC,EAAD,CAAb,CAAkB/B,OAAlB;MACA,OAAOT,aAAa,CAACwC,EAAD,CAApB;IACD;;IACDtC,WAAW,GAAG,IAAd;EACD;AACF;;AAED,SAAS+B,cAAT,CAAwBc,KAAxB,EAA+B;EAC7B,OAAO;IACLC,IAAI,EAAED,KAAK,CAACC,IADP;IAELC,UAAU,EAAEF,KAAK,CAACE,UAFb;IAGLC,UAAU,EAAEH,KAAK,CAACG,UAHb;IAILC,KAAK,EAAEJ,KAAK,CAACI,KAJR;IAKLC,SAAS,EAAEL,KAAK,CAACK,SALZ;IAMLC,gBAAgB,EAAEN,KAAK,CAACM,gBANnB;IAOLC,YAAY,EAAEP,KAAK,CAACO,YAPf;IAQLC,SAAS,EAAER,KAAK,CAACQ,SARZ;IASLC,UAAU,EAAET,KAAK,CAACS,UATb;IAULC,MAAM,EAAEV,KAAK,CAACU,MAVT;IAWLC,QAAQ,EAAEX,KAAK,CAACW,QAXX;IAYLC,OAAO,EAAEZ,KAAK,CAACY,OAZV;IAaLC,KAAK,EAAEb,KAAK,CAACa,KAbR;IAcLC,OAAO,EAAEd,KAAK,CAACc,OAdV;IAeLC,SAAS,EAAEf,KAAK,CAACe,SAfZ;IAgBLC,SAAS,EAAEhB,KAAK,CAACgB;EAhBZ,CAAP;AAkBD"},"metadata":{},"sourceType":"script"}