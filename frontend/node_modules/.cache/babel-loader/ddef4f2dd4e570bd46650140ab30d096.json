{"ast":null,"code":"\"use strict\"; // Copyright (c) 2018-2022 Coinbase, Inc. <https://www.coinbase.com/>\n// Licensed under the Apache License, version 2.0\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.WalletSDKRelay = void 0;\n\nconst bind_decorator_1 = __importDefault(require(\"bind-decorator\"));\n\nconst eth_rpc_errors_1 = require(\"eth-rpc-errors\");\n\nconst rxjs_1 = require(\"rxjs\");\n\nconst operators_1 = require(\"rxjs/operators\");\n\nconst DiagnosticLogger_1 = require(\"../connection/DiagnosticLogger\");\n\nconst WalletSDKConnection_1 = require(\"../connection/WalletSDKConnection\");\n\nconst WalletUIError_1 = require(\"../provider/WalletUIError\");\n\nconst types_1 = require(\"../types\");\n\nconst util_1 = require(\"../util\");\n\nconst aes256gcm = __importStar(require(\"./aes256gcm\"));\n\nconst Session_1 = require(\"./Session\");\n\nconst WalletSDKRelayAbstract_1 = require(\"./WalletSDKRelayAbstract\");\n\nconst Web3Method_1 = require(\"./Web3Method\");\n\nconst Web3RequestCanceledMessage_1 = require(\"./Web3RequestCanceledMessage\");\n\nconst Web3RequestMessage_1 = require(\"./Web3RequestMessage\");\n\nconst Web3Response_1 = require(\"./Web3Response\");\n\nconst Web3ResponseMessage_1 = require(\"./Web3ResponseMessage\");\n\nclass WalletSDKRelay extends WalletSDKRelayAbstract_1.WalletSDKRelayAbstract {\n  constructor(options) {\n    var _a;\n\n    super();\n    this.accountsCallback = null;\n    this.chainCallback = null;\n    this.dappDefaultChainSubject = new rxjs_1.BehaviorSubject(1);\n    this.dappDefaultChain = 1;\n    this.appName = \"\";\n    this.appLogoUrl = null;\n    this.subscriptions = new rxjs_1.Subscription();\n    this.linkAPIUrl = options.linkAPIUrl;\n    this.storage = options.storage;\n    this.options = options;\n    const {\n      session,\n      ui,\n      connection\n    } = this.subscribe();\n    this._session = session;\n    this.connection = connection;\n    this.relayEventManager = options.relayEventManager;\n\n    if (options.diagnosticLogger && options.eventListener) {\n      throw new Error(\"Can't have both eventListener and diagnosticLogger options, use only diagnosticLogger\");\n    }\n\n    if (options.eventListener) {\n      this.diagnostic = {\n        // eslint-disable-next-line @typescript-eslint/unbound-method\n        log: options.eventListener.onEvent\n      };\n    } else {\n      this.diagnostic = options.diagnosticLogger;\n    }\n\n    this._reloadOnDisconnect = (_a = options.reloadOnDisconnect) !== null && _a !== void 0 ? _a : true;\n    this.ui = ui;\n  }\n\n  subscribe() {\n    this.subscriptions.add(this.dappDefaultChainSubject.subscribe(chainId => {\n      if (this.dappDefaultChain !== chainId) {\n        this.dappDefaultChain = chainId;\n      }\n    }));\n    const session = Session_1.Session.load(this.storage) || new Session_1.Session(this.storage).save();\n    const connection = new WalletSDKConnection_1.WalletSDKConnection(session.id, session.key, this.linkAPIUrl, this.diagnostic);\n    this.subscriptions.add(connection.sessionConfig$.subscribe({\n      next: sessionConfig => {\n        this.onSessionConfigChanged(sessionConfig);\n      },\n      error: () => {\n        var _a;\n\n        (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n          message: \"error while invoking session config callback\"\n        });\n      }\n    }));\n    this.subscriptions.add(connection.incomingEvent$.pipe((0, operators_1.filter)(m => m.event === \"Web3Response\")).subscribe({\n      next: this.handleIncomingEvent\n    }));\n    this.subscriptions.add(connection.linked$.pipe((0, operators_1.skip)(1), (0, operators_1.tap)(linked => {\n      var _a;\n\n      this.isLinked = linked;\n      const cachedAddresses = this.storage.getItem(WalletSDKRelayAbstract_1.LOCAL_STORAGE_ADDRESSES_KEY);\n\n      if (linked) {\n        // Only set linked session variable one way\n        this.session.linked = linked;\n      }\n\n      this.isUnlinkedErrorState = false;\n\n      if (cachedAddresses) {\n        const addresses = cachedAddresses.split(\" \");\n        const wasConnectedViaStandalone = this.storage.getItem(\"IsStandaloneSigning\") === \"true\";\n\n        if (addresses[0] !== \"\" && !linked && this.session.linked && !wasConnectedViaStandalone) {\n          this.isUnlinkedErrorState = true;\n          const sessionIdHash = this.getSessionIdHash();\n          (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.UNLINKED_ERROR_STATE, {\n            sessionIdHash\n          });\n        }\n      }\n    })).subscribe()); // if session is marked destroyed, reset and reload\n\n    this.subscriptions.add(connection.sessionConfig$.pipe((0, operators_1.filter)(c => !!c.metadata && c.metadata.__destroyed === \"1\")).subscribe(() => {\n      var _a;\n\n      const alreadyDestroyed = connection.isDestroyed;\n      (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.METADATA_DESTROYED, {\n        alreadyDestroyed,\n        sessionIdHash: this.getSessionIdHash()\n      });\n      return this.resetAndReload();\n    }));\n    this.subscriptions.add(connection.sessionConfig$.pipe((0, operators_1.filter)(c => c.metadata && c.metadata.WalletUsername !== undefined)).pipe((0, operators_1.mergeMap)(c => aes256gcm.decrypt(c.metadata.WalletUsername, session.secret))).subscribe({\n      next: walletUsername => {\n        this.storage.setItem(WalletSDKRelayAbstract_1.WALLET_USER_NAME_KEY, walletUsername);\n      },\n      error: () => {\n        var _a;\n\n        (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n          message: \"Had error decrypting\",\n          value: \"username\"\n        });\n      }\n    }));\n    this.subscriptions.add(connection.sessionConfig$.pipe((0, operators_1.filter)(c => c.metadata && c.metadata.AppVersion !== undefined)).pipe((0, operators_1.mergeMap)(c => aes256gcm.decrypt(c.metadata.AppVersion, session.secret))).subscribe({\n      next: appVersion => {\n        this.storage.setItem(WalletSDKRelayAbstract_1.APP_VERSION_KEY, appVersion);\n      },\n      error: () => {\n        var _a;\n\n        (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n          message: \"Had error decrypting\",\n          value: \"appversion\"\n        });\n      }\n    }));\n    this.subscriptions.add(connection.sessionConfig$.pipe((0, operators_1.filter)(c => c.metadata && c.metadata.ChainId !== undefined && c.metadata.JsonRpcUrl !== undefined)).pipe((0, operators_1.mergeMap)(c => (0, rxjs_1.zip)(aes256gcm.decrypt(c.metadata.ChainId, session.secret), aes256gcm.decrypt(c.metadata.JsonRpcUrl, session.secret)))).pipe((0, operators_1.distinctUntilChanged)()).subscribe({\n      next: _ref => {\n        let [chainId, jsonRpcUrl] = _ref;\n\n        if (this.chainCallback) {\n          this.chainCallback(chainId, jsonRpcUrl);\n        }\n      },\n      error: () => {\n        var _a;\n\n        (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n          message: \"Had error decrypting\",\n          value: \"chainId|jsonRpcUrl\"\n        });\n      }\n    }));\n    this.subscriptions.add(connection.sessionConfig$.pipe((0, operators_1.filter)(c => c.metadata && c.metadata.EthereumAddress !== undefined)).pipe((0, operators_1.mergeMap)(c => aes256gcm.decrypt(c.metadata.EthereumAddress, session.secret))).subscribe({\n      next: selectedAddress => {\n        if (this.accountsCallback) {\n          this.accountsCallback([selectedAddress]);\n        }\n\n        if (WalletSDKRelay.accountRequestCallbackIds.size > 0) {\n          // We get the ethereum address from the metadata.  If for whatever\n          // reason we don't get a response via an explicit web3 message\n          // we can still fulfill the eip1102 request.\n          Array.from(WalletSDKRelay.accountRequestCallbackIds.values()).forEach(id => {\n            const message = (0, Web3ResponseMessage_1.Web3ResponseMessage)({\n              id,\n              response: (0, Web3Response_1.RequestEthereumAccountsResponse)([selectedAddress])\n            });\n            this.invokeCallback(Object.assign(Object.assign({}, message), {\n              id\n            }));\n          });\n          WalletSDKRelay.accountRequestCallbackIds.clear();\n        }\n      },\n      error: () => {\n        var _a;\n\n        (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n          message: \"Had error decrypting\",\n          value: \"selectedAddress\"\n        });\n      }\n    }));\n    this.subscriptions.add(connection.sessionConfig$.pipe((0, operators_1.filter)(c => c.metadata && c.metadata.AppSrc !== undefined)).pipe((0, operators_1.mergeMap)(c => aes256gcm.decrypt(c.metadata.AppSrc, session.secret))).subscribe({\n      next: appSrc => {\n        this.ui.setAppSrc(appSrc);\n      },\n      error: () => {\n        var _a;\n\n        (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n          message: \"Had error decrypting\",\n          value: \"appSrc\"\n        });\n      }\n    }));\n    const ui = this.options.uiConstructor({\n      linkAPIUrl: this.options.linkAPIUrl,\n      version: this.options.version,\n      darkMode: this.options.darkMode,\n      session,\n      connected$: connection.connected$,\n      chainId$: this.dappDefaultChainSubject\n    });\n    connection.connect();\n    return {\n      session,\n      ui,\n      connection\n    };\n  }\n\n  attachUI() {\n    this.ui.attach();\n  }\n\n  resetAndReload() {\n    this.connection.setSessionMetadata(\"__destroyed\", \"1\").pipe((0, operators_1.timeout)(1000), (0, operators_1.catchError)(_ => (0, rxjs_1.of)(null))).subscribe(_ => {\n      var _a, _b, _c;\n\n      const isStandalone = this.ui.isStandalone();\n\n      try {\n        this.subscriptions.unsubscribe();\n      } catch (err) {\n        (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n          message: \"Had error unsubscribing\"\n        });\n      }\n\n      (_b = this.diagnostic) === null || _b === void 0 ? void 0 : _b.log(DiagnosticLogger_1.EVENTS.SESSION_STATE_CHANGE, {\n        method: \"relay::resetAndReload\",\n        sessionMetadataChange: \"__destroyed, 1\",\n        sessionIdHash: this.getSessionIdHash()\n      });\n      this.connection.destroy();\n      /**\n       * Only clear storage if the session id we have in memory matches the one on disk\n       * Otherwise, in the case where we have 2 tabs, another tab might have cleared\n       * storage already.  In that case if we clear storage again, the user will be in\n       * a state where the first tab allows the user to connect but the session that\n       * was used isn't persisted.  This leaves the user in a state where they aren't\n       * connected to the mobile app.\n       */\n\n      const storedSession = Session_1.Session.load(this.storage);\n\n      if ((storedSession === null || storedSession === void 0 ? void 0 : storedSession.id) === this._session.id) {\n        this.storage.clear();\n      } else if (storedSession) {\n        (_c = this.diagnostic) === null || _c === void 0 ? void 0 : _c.log(DiagnosticLogger_1.EVENTS.SKIPPED_CLEARING_SESSION, {\n          sessionIdHash: this.getSessionIdHash(),\n          storedSessionIdHash: Session_1.Session.hash(storedSession.id)\n        });\n      }\n\n      if (this._reloadOnDisconnect) {\n        this.ui.reloadUI();\n        return;\n      }\n\n      if (this.accountsCallback) {\n        this.accountsCallback([], true);\n      }\n\n      const {\n        session,\n        ui,\n        connection\n      } = this.subscribe();\n      this._session = session;\n      this.connection = connection;\n      this.ui = ui;\n      if (isStandalone && this.ui.setStandalone) this.ui.setStandalone(true);\n      this.attachUI();\n    }, err => {\n      var _a;\n\n      (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.FAILURE, {\n        method: \"relay::resetAndReload\",\n        message: `failed to reset and reload with ${err}`,\n        sessionIdHash: this.getSessionIdHash()\n      });\n    });\n  }\n\n  setAppInfo(appName, appLogoUrl) {\n    this.appName = appName;\n    this.appLogoUrl = appLogoUrl;\n  }\n\n  getStorageItem(key) {\n    return this.storage.getItem(key);\n  }\n\n  get session() {\n    return this._session;\n  }\n\n  setStorageItem(key, value) {\n    this.storage.setItem(key, value);\n  }\n\n  signEthereumMessage(message, address, addPrefix, typedDataJson) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.signEthereumMessage,\n      params: {\n        message: (0, util_1.hexStringFromBuffer)(message, true),\n        address,\n        addPrefix,\n        typedDataJson: typedDataJson || null\n      }\n    });\n  }\n\n  ethereumAddressFromSignedMessage(message, signature, addPrefix) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.ethereumAddressFromSignedMessage,\n      params: {\n        message: (0, util_1.hexStringFromBuffer)(message, true),\n        signature: (0, util_1.hexStringFromBuffer)(signature, true),\n        addPrefix\n      }\n    });\n  }\n\n  signEthereumTransaction(params) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.signEthereumTransaction,\n      params: {\n        fromAddress: params.fromAddress,\n        toAddress: params.toAddress,\n        weiValue: (0, util_1.bigIntStringFromBN)(params.weiValue),\n        data: (0, util_1.hexStringFromBuffer)(params.data, true),\n        nonce: params.nonce,\n        gasPriceInWei: params.gasPriceInWei ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei) : null,\n        maxFeePerGas: params.gasPriceInWei ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei) : null,\n        maxPriorityFeePerGas: params.gasPriceInWei ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei) : null,\n        gasLimit: params.gasLimit ? (0, util_1.bigIntStringFromBN)(params.gasLimit) : null,\n        chainId: params.chainId,\n        shouldSubmit: false\n      }\n    });\n  }\n\n  signAndSubmitEthereumTransaction(params) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.signEthereumTransaction,\n      params: {\n        fromAddress: params.fromAddress,\n        toAddress: params.toAddress,\n        weiValue: (0, util_1.bigIntStringFromBN)(params.weiValue),\n        data: (0, util_1.hexStringFromBuffer)(params.data, true),\n        nonce: params.nonce,\n        gasPriceInWei: params.gasPriceInWei ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei) : null,\n        maxFeePerGas: params.maxFeePerGas ? (0, util_1.bigIntStringFromBN)(params.maxFeePerGas) : null,\n        maxPriorityFeePerGas: params.maxPriorityFeePerGas ? (0, util_1.bigIntStringFromBN)(params.maxPriorityFeePerGas) : null,\n        gasLimit: params.gasLimit ? (0, util_1.bigIntStringFromBN)(params.gasLimit) : null,\n        chainId: params.chainId,\n        shouldSubmit: true\n      }\n    });\n  }\n\n  submitEthereumTransaction(signedTransaction, chainId) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.submitEthereumTransaction,\n      params: {\n        signedTransaction: (0, util_1.hexStringFromBuffer)(signedTransaction, true),\n        chainId\n      }\n    });\n  }\n\n  scanQRCode(regExp) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.scanQRCode,\n      params: {\n        regExp\n      }\n    });\n  }\n\n  getQRCodeUrl() {\n    return (0, util_1.createQrUrl)(this._session.id, this._session.secret, this.linkAPIUrl, false, this.options.version, this.dappDefaultChain);\n  }\n\n  genericRequest(data, action) {\n    return this.sendRequest({\n      method: Web3Method_1.Web3Method.generic,\n      params: {\n        action,\n        data\n      }\n    });\n  }\n\n  sendGenericMessage(request) {\n    return this.sendRequest(request);\n  }\n\n  sendRequest(request) {\n    let hideSnackbarItem = null;\n    const id = (0, util_1.randomBytesHex)(8);\n\n    const cancel = error => {\n      this.publishWeb3RequestCanceledEvent(id);\n      this.handleErrorResponse(id, request.method, error);\n      hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n    };\n\n    const promise = new Promise((resolve, reject) => {\n      if (!this.ui.isStandalone()) {\n        hideSnackbarItem = this.ui.showConnecting({\n          isUnlinkedErrorState: this.isUnlinkedErrorState,\n          onCancel: cancel,\n          onResetConnection: this.resetAndReload // eslint-disable-line @typescript-eslint/unbound-method\n\n        });\n      }\n\n      this.relayEventManager.callbacks.set(id, response => {\n        hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n\n        if (response.errorMessage) {\n          return reject(new Error(response.errorMessage));\n        }\n\n        resolve(response);\n      });\n\n      if (this.ui.isStandalone()) {\n        this.sendRequestStandalone(id, request);\n      } else {\n        this.publishWeb3RequestEvent(id, request);\n      }\n    });\n    return {\n      promise,\n      cancel\n    };\n  }\n\n  setConnectDisabled(disabled) {\n    this.ui.setConnectDisabled(disabled);\n  }\n\n  setAccountsCallback(accountsCallback) {\n    this.accountsCallback = accountsCallback;\n  }\n\n  setChainCallback(chainCallback) {\n    this.chainCallback = chainCallback;\n  }\n\n  setDappDefaultChainCallback(chainId) {\n    this.dappDefaultChainSubject.next(chainId);\n  }\n\n  publishWeb3RequestEvent(id, request) {\n    var _a;\n\n    const message = (0, Web3RequestMessage_1.Web3RequestMessage)({\n      id,\n      request\n    });\n    const storedSession = Session_1.Session.load(this.storage);\n    (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.WEB3_REQUEST, {\n      eventId: message.id,\n      method: `relay::${message.request.method}`,\n      sessionIdHash: this.getSessionIdHash(),\n      storedSessionIdHash: storedSession ? Session_1.Session.hash(storedSession.id) : \"\",\n      isSessionMismatched: ((storedSession === null || storedSession === void 0 ? void 0 : storedSession.id) !== this._session.id).toString()\n    });\n    this.subscriptions.add(this.publishEvent(\"Web3Request\", message, true).subscribe({\n      next: _ => {\n        var _a;\n\n        (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.WEB3_REQUEST_PUBLISHED, {\n          eventId: message.id,\n          method: `relay::${message.request.method}`,\n          sessionIdHash: this.getSessionIdHash(),\n          storedSessionIdHash: storedSession ? Session_1.Session.hash(storedSession.id) : \"\",\n          isSessionMismatched: ((storedSession === null || storedSession === void 0 ? void 0 : storedSession.id) !== this._session.id).toString()\n        });\n      },\n      error: err => {\n        this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n          id: message.id,\n          response: {\n            method: message.request.method,\n            errorMessage: err.message\n          }\n        }));\n      }\n    }));\n  }\n\n  publishWeb3RequestCanceledEvent(id) {\n    const message = (0, Web3RequestCanceledMessage_1.Web3RequestCanceledMessage)(id);\n    this.subscriptions.add(this.publishEvent(\"Web3RequestCanceled\", message, false).subscribe());\n  }\n\n  publishEvent(event, message, callWebhook) {\n    const secret = this.session.secret;\n    return new rxjs_1.Observable(subscriber => {\n      void aes256gcm.encrypt(JSON.stringify(Object.assign(Object.assign({}, message), {\n        origin: location.origin\n      })), secret).then(encrypted => {\n        subscriber.next(encrypted);\n        subscriber.complete();\n      });\n    }).pipe((0, operators_1.mergeMap)(encrypted => {\n      return this.connection.publishEvent(event, encrypted, callWebhook);\n    }));\n  }\n\n  handleIncomingEvent(event) {\n    try {\n      this.subscriptions.add(aes256gcm.decrypt(event.data, this.session.secret).pipe((0, operators_1.map)(c => JSON.parse(c))).subscribe({\n        next: json => {\n          const message = (0, Web3ResponseMessage_1.isWeb3ResponseMessage)(json) ? json : null;\n\n          if (!message) {\n            return;\n          }\n\n          this.handleWeb3ResponseMessage(message);\n        },\n        error: () => {\n          var _a;\n\n          (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n            message: \"Had error decrypting\",\n            value: \"incomingEvent\"\n          });\n        }\n      }));\n    } catch (_a) {\n      return;\n    }\n  }\n\n  handleWeb3ResponseMessage(message) {\n    var _a;\n\n    const {\n      response\n    } = message;\n    (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.WEB3_RESPONSE, {\n      eventId: message.id,\n      method: `relay::${response.method}`,\n      sessionIdHash: this.getSessionIdHash()\n    });\n\n    if ((0, Web3Response_1.isRequestEthereumAccountsResponse)(response)) {\n      WalletSDKRelay.accountRequestCallbackIds.forEach(id => this.invokeCallback(Object.assign(Object.assign({}, message), {\n        id\n      })));\n      WalletSDKRelay.accountRequestCallbackIds.clear();\n      return;\n    }\n\n    this.invokeCallback(message);\n  }\n\n  handleErrorResponse(id, method, error, errorCode) {\n    this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n      id,\n      response: (0, Web3Response_1.ErrorResponse)(method, (error !== null && error !== void 0 ? error : WalletUIError_1.WalletUIError.UserRejectedRequest).message, errorCode)\n    }));\n  }\n\n  invokeCallback(message) {\n    const callback = this.relayEventManager.callbacks.get(message.id);\n\n    if (callback) {\n      callback(message.response);\n      this.relayEventManager.callbacks.delete(message.id);\n    }\n  }\n\n  requestEthereumAccounts() {\n    const request = {\n      method: Web3Method_1.Web3Method.requestEthereumAccounts,\n      params: {\n        appName: this.appName,\n        appLogoUrl: this.appLogoUrl || null\n      }\n    };\n    const hideSnackbarItem = null;\n    const id = (0, util_1.randomBytesHex)(8);\n\n    const cancel = error => {\n      this.publishWeb3RequestCanceledEvent(id);\n      this.handleErrorResponse(id, request.method, error); // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore\n\n      hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n    };\n\n    const promise = new Promise((resolve, reject) => {\n      var _a;\n\n      this.relayEventManager.callbacks.set(id, response => {\n        this.ui.hideRequestEthereumAccounts(); // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n        // @ts-ignore\n\n        hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n\n        if (response.errorMessage) {\n          return reject(new Error(response.errorMessage));\n        }\n\n        resolve(response);\n      });\n      const userAgent = ((_a = window === null || window === void 0 ? void 0 : window.navigator) === null || _a === void 0 ? void 0 : _a.userAgent) || null;\n\n      if (userAgent && /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)) {\n        let location;\n\n        try {\n          if ((0, util_1.isInIFrame)() && window.top) {\n            location = window.top.location;\n          } else {\n            location = window.location;\n          }\n        } catch (e) {\n          location = window.location;\n        }\n\n        location.href = `https://www.coinbase.com/connect-dapp?uri=${encodeURIComponent(location.href)}`;\n        return;\n      }\n\n      if (this.ui.inlineAccountsResponse()) {\n        const onAccounts = accounts => {\n          this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n            id,\n            response: (0, Web3Response_1.RequestEthereumAccountsResponse)(accounts)\n          }));\n        };\n\n        this.ui.requestEthereumAccounts({\n          onCancel: cancel,\n          onAccounts\n        });\n      } else {\n        // Error if user closes TryExtensionLinkDialog without connecting\n        const err = eth_rpc_errors_1.ethErrors.provider.userRejectedRequest(\"User denied account authorization\");\n        this.ui.requestEthereumAccounts({\n          onCancel: () => cancel(err)\n        });\n      }\n\n      WalletSDKRelay.accountRequestCallbackIds.add(id);\n\n      if (!this.ui.inlineAccountsResponse() && !this.ui.isStandalone()) {\n        this.publishWeb3RequestEvent(id, request);\n      }\n    });\n    return {\n      promise,\n      cancel\n    };\n  }\n\n  selectProvider(providerOptions) {\n    const request = {\n      method: Web3Method_1.Web3Method.selectProvider,\n      params: {\n        providerOptions\n      }\n    };\n    const id = (0, util_1.randomBytesHex)(8);\n\n    const cancel = error => {\n      this.publishWeb3RequestCanceledEvent(id);\n      this.handleErrorResponse(id, request.method, error);\n    };\n\n    const promise = new Promise((resolve, reject) => {\n      this.relayEventManager.callbacks.set(id, response => {\n        if (response.errorMessage) {\n          return reject(new Error(response.errorMessage));\n        }\n\n        resolve(response);\n      });\n\n      const _cancel = _error => {\n        this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n          id,\n          response: (0, Web3Response_1.SelectProviderResponse)(types_1.ProviderType.Unselected)\n        }));\n      };\n\n      const approve = selectedProviderKey => {\n        this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n          id,\n          response: (0, Web3Response_1.SelectProviderResponse)(selectedProviderKey)\n        }));\n      };\n\n      if (this.ui.selectProvider) this.ui.selectProvider({\n        onApprove: approve,\n        onCancel: _cancel,\n        providerOptions\n      });\n    });\n    return {\n      cancel,\n      promise\n    };\n  }\n\n  watchAsset(type, address, symbol, decimals, image, chainId) {\n    const request = {\n      method: Web3Method_1.Web3Method.watchAsset,\n      params: {\n        type,\n        options: {\n          address,\n          symbol,\n          decimals,\n          image\n        },\n        chainId\n      }\n    };\n    let hideSnackbarItem = null;\n    const id = (0, util_1.randomBytesHex)(8);\n\n    const cancel = error => {\n      this.publishWeb3RequestCanceledEvent(id);\n      this.handleErrorResponse(id, request.method, error);\n      hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n    };\n\n    if (!this.ui.inlineWatchAsset()) {\n      hideSnackbarItem = this.ui.showConnecting({\n        isUnlinkedErrorState: this.isUnlinkedErrorState,\n        onCancel: cancel,\n        onResetConnection: this.resetAndReload // eslint-disable-line @typescript-eslint/unbound-method\n\n      });\n    }\n\n    const promise = new Promise((resolve, reject) => {\n      this.relayEventManager.callbacks.set(id, response => {\n        hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n\n        if (response.errorMessage) {\n          return reject(new Error(response.errorMessage));\n        }\n\n        resolve(response);\n      });\n\n      const _cancel = _error => {\n        this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n          id,\n          response: (0, Web3Response_1.WatchAssetReponse)(false)\n        }));\n      };\n\n      const approve = () => {\n        this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n          id,\n          response: (0, Web3Response_1.WatchAssetReponse)(true)\n        }));\n      };\n\n      if (this.ui.inlineWatchAsset()) {\n        this.ui.watchAsset({\n          onApprove: approve,\n          onCancel: _cancel,\n          type,\n          address,\n          symbol,\n          decimals,\n          image,\n          chainId\n        });\n      }\n\n      if (!this.ui.inlineWatchAsset() && !this.ui.isStandalone()) {\n        this.publishWeb3RequestEvent(id, request);\n      }\n    });\n    return {\n      cancel,\n      promise\n    };\n  }\n\n  addEthereumChain(chainId, rpcUrls, iconUrls, blockExplorerUrls, chainName, nativeCurrency) {\n    const request = {\n      method: Web3Method_1.Web3Method.addEthereumChain,\n      params: {\n        chainId,\n        rpcUrls,\n        blockExplorerUrls,\n        chainName,\n        iconUrls,\n        nativeCurrency\n      }\n    };\n    let hideSnackbarItem = null;\n    const id = (0, util_1.randomBytesHex)(8);\n\n    const cancel = error => {\n      this.publishWeb3RequestCanceledEvent(id);\n      this.handleErrorResponse(id, request.method, error);\n      hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n    };\n\n    if (!this.ui.inlineAddEthereumChain(chainId)) {\n      hideSnackbarItem = this.ui.showConnecting({\n        isUnlinkedErrorState: this.isUnlinkedErrorState,\n        onCancel: cancel,\n        onResetConnection: this.resetAndReload // eslint-disable-line @typescript-eslint/unbound-method\n\n      });\n    }\n\n    const promise = new Promise((resolve, reject) => {\n      this.relayEventManager.callbacks.set(id, response => {\n        hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n\n        if (response.errorMessage) {\n          return reject(new Error(response.errorMessage));\n        }\n\n        resolve(response);\n      });\n\n      const _cancel = _error => {\n        this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n          id,\n          response: (0, Web3Response_1.AddEthereumChainResponse)({\n            isApproved: false,\n            rpcUrl: \"\"\n          })\n        }));\n      };\n\n      const approve = rpcUrl => {\n        this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n          id,\n          response: (0, Web3Response_1.AddEthereumChainResponse)({\n            isApproved: true,\n            rpcUrl\n          })\n        }));\n      };\n\n      if (this.ui.inlineAddEthereumChain(chainId)) {\n        this.ui.addEthereumChain({\n          onCancel: _cancel,\n          onApprove: approve,\n          chainId: request.params.chainId,\n          rpcUrls: request.params.rpcUrls,\n          blockExplorerUrls: request.params.blockExplorerUrls,\n          chainName: request.params.chainName,\n          iconUrls: request.params.iconUrls,\n          nativeCurrency: request.params.nativeCurrency\n        });\n      }\n\n      if (!this.ui.inlineAddEthereumChain(chainId) && !this.ui.isStandalone()) {\n        this.publishWeb3RequestEvent(id, request);\n      }\n    });\n    return {\n      promise,\n      cancel\n    };\n  }\n\n  switchEthereumChain(chainId, address) {\n    const request = {\n      method: Web3Method_1.Web3Method.switchEthereumChain,\n      params: Object.assign({\n        chainId\n      }, {\n        address\n      })\n    };\n    const id = (0, util_1.randomBytesHex)(8);\n\n    const cancel = error => {\n      this.publishWeb3RequestCanceledEvent(id);\n      this.handleErrorResponse(id, request.method, error);\n    };\n\n    const promise = new Promise((resolve, reject) => {\n      this.relayEventManager.callbacks.set(id, response => {\n        if (response.errorMessage && response.errorCode) {\n          return reject(eth_rpc_errors_1.ethErrors.provider.custom({\n            code: response.errorCode,\n            message: `Unrecognized chain ID. Try adding the chain using addEthereumChain first.`\n          }));\n        } else if (response.errorMessage) {\n          return reject(new Error(response.errorMessage));\n        }\n\n        resolve(response);\n      });\n\n      const _cancel = error => {\n        if (typeof error === \"number\") {\n          // backward compatibility\n          const errorCode = error;\n          this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n            id,\n            response: (0, Web3Response_1.ErrorResponse)(Web3Method_1.Web3Method.switchEthereumChain, WalletUIError_1.WalletUIError.SwitchEthereumChainUnsupportedChainId.message, errorCode)\n          }));\n        } else if (error instanceof WalletUIError_1.WalletUIError) {\n          this.handleErrorResponse(id, Web3Method_1.Web3Method.switchEthereumChain, error, error.errorCode);\n        } else {\n          this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n            id,\n            response: (0, Web3Response_1.SwitchEthereumChainResponse)({\n              isApproved: false,\n              rpcUrl: \"\"\n            })\n          }));\n        }\n      };\n\n      const approve = rpcUrl => {\n        this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n          id,\n          response: (0, Web3Response_1.SwitchEthereumChainResponse)({\n            isApproved: true,\n            rpcUrl\n          })\n        }));\n      };\n\n      this.ui.switchEthereumChain({\n        onCancel: _cancel,\n        onApprove: approve,\n        chainId: request.params.chainId,\n        address: request.params.address\n      });\n\n      if (!this.ui.inlineSwitchEthereumChain() && !this.ui.isStandalone()) {\n        this.publishWeb3RequestEvent(id, request);\n      }\n    });\n    return {\n      promise,\n      cancel\n    };\n  }\n\n  inlineAddEthereumChain(chainId) {\n    return this.ui.inlineAddEthereumChain(chainId);\n  }\n\n  getSessionIdHash() {\n    return Session_1.Session.hash(this._session.id);\n  }\n\n  sendRequestStandalone(id, request) {\n    const _cancel = error => {\n      this.handleErrorResponse(id, request.method, error);\n    };\n\n    const onSuccess = response => {\n      this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n        id,\n        response\n      }));\n    };\n\n    switch (request.method) {\n      case Web3Method_1.Web3Method.signEthereumMessage:\n        this.ui.signEthereumMessage({\n          request,\n          onSuccess,\n          onCancel: _cancel\n        });\n        break;\n\n      case Web3Method_1.Web3Method.signEthereumTransaction:\n        this.ui.signEthereumTransaction({\n          request,\n          onSuccess,\n          onCancel: _cancel\n        });\n        break;\n\n      case Web3Method_1.Web3Method.submitEthereumTransaction:\n        this.ui.submitEthereumTransaction({\n          request,\n          onSuccess,\n          onCancel: _cancel\n        });\n        break;\n\n      case Web3Method_1.Web3Method.ethereumAddressFromSignedMessage:\n        this.ui.ethereumAddressFromSignedMessage({\n          request,\n          onSuccess\n        });\n        break;\n\n      default:\n        _cancel();\n\n        break;\n    }\n  }\n\n  onSessionConfigChanged(_nextSessionConfig) {}\n\n}\n\nWalletSDKRelay.accountRequestCallbackIds = new Set();\n\n__decorate([bind_decorator_1.default], WalletSDKRelay.prototype, \"resetAndReload\", null);\n\n__decorate([bind_decorator_1.default], WalletSDKRelay.prototype, \"handleIncomingEvent\", null);\n\nexports.WalletSDKRelay = WalletSDKRelay;","map":{"version":3,"names":["__createBinding","Object","create","o","m","k","k2","undefined","defineProperty","enumerable","get","__setModuleDefault","v","value","__decorate","decorators","target","key","desc","c","arguments","length","r","getOwnPropertyDescriptor","d","Reflect","decorate","i","__importStar","mod","__esModule","result","prototype","hasOwnProperty","call","__importDefault","exports","WalletSDKRelay","bind_decorator_1","require","eth_rpc_errors_1","rxjs_1","operators_1","DiagnosticLogger_1","WalletSDKConnection_1","WalletUIError_1","types_1","util_1","aes256gcm","Session_1","WalletSDKRelayAbstract_1","Web3Method_1","Web3RequestCanceledMessage_1","Web3RequestMessage_1","Web3Response_1","Web3ResponseMessage_1","WalletSDKRelayAbstract","constructor","options","_a","accountsCallback","chainCallback","dappDefaultChainSubject","BehaviorSubject","dappDefaultChain","appName","appLogoUrl","subscriptions","Subscription","linkAPIUrl","storage","session","ui","connection","subscribe","_session","relayEventManager","diagnosticLogger","eventListener","Error","diagnostic","log","onEvent","_reloadOnDisconnect","reloadOnDisconnect","add","chainId","Session","load","save","WalletSDKConnection","id","sessionConfig$","next","sessionConfig","onSessionConfigChanged","error","EVENTS","GENERAL_ERROR","message","incomingEvent$","pipe","filter","event","handleIncomingEvent","linked$","skip","tap","linked","isLinked","cachedAddresses","getItem","LOCAL_STORAGE_ADDRESSES_KEY","isUnlinkedErrorState","addresses","split","wasConnectedViaStandalone","sessionIdHash","getSessionIdHash","UNLINKED_ERROR_STATE","metadata","__destroyed","alreadyDestroyed","isDestroyed","METADATA_DESTROYED","resetAndReload","WalletUsername","mergeMap","decrypt","secret","walletUsername","setItem","WALLET_USER_NAME_KEY","AppVersion","appVersion","APP_VERSION_KEY","ChainId","JsonRpcUrl","zip","distinctUntilChanged","jsonRpcUrl","EthereumAddress","selectedAddress","accountRequestCallbackIds","size","Array","from","values","forEach","Web3ResponseMessage","response","RequestEthereumAccountsResponse","invokeCallback","assign","clear","AppSrc","appSrc","setAppSrc","uiConstructor","version","darkMode","connected$","chainId$","connect","attachUI","attach","setSessionMetadata","timeout","catchError","_","of","_b","_c","isStandalone","unsubscribe","err","SESSION_STATE_CHANGE","method","sessionMetadataChange","destroy","storedSession","SKIPPED_CLEARING_SESSION","storedSessionIdHash","hash","reloadUI","setStandalone","FAILURE","setAppInfo","getStorageItem","setStorageItem","signEthereumMessage","address","addPrefix","typedDataJson","sendRequest","Web3Method","params","hexStringFromBuffer","ethereumAddressFromSignedMessage","signature","signEthereumTransaction","fromAddress","toAddress","weiValue","bigIntStringFromBN","data","nonce","gasPriceInWei","maxFeePerGas","maxPriorityFeePerGas","gasLimit","shouldSubmit","signAndSubmitEthereumTransaction","submitEthereumTransaction","signedTransaction","scanQRCode","regExp","getQRCodeUrl","createQrUrl","genericRequest","action","generic","sendGenericMessage","request","hideSnackbarItem","randomBytesHex","cancel","publishWeb3RequestCanceledEvent","handleErrorResponse","promise","Promise","resolve","reject","showConnecting","onCancel","onResetConnection","callbacks","set","errorMessage","sendRequestStandalone","publishWeb3RequestEvent","setConnectDisabled","disabled","setAccountsCallback","setChainCallback","setDappDefaultChainCallback","Web3RequestMessage","WEB3_REQUEST","eventId","isSessionMismatched","toString","publishEvent","WEB3_REQUEST_PUBLISHED","handleWeb3ResponseMessage","Web3RequestCanceledMessage","callWebhook","Observable","subscriber","encrypt","JSON","stringify","origin","location","then","encrypted","complete","map","parse","json","isWeb3ResponseMessage","WEB3_RESPONSE","isRequestEthereumAccountsResponse","errorCode","ErrorResponse","WalletUIError","UserRejectedRequest","callback","delete","requestEthereumAccounts","hideRequestEthereumAccounts","userAgent","window","navigator","test","isInIFrame","top","e","href","encodeURIComponent","inlineAccountsResponse","onAccounts","accounts","ethErrors","provider","userRejectedRequest","selectProvider","providerOptions","_cancel","_error","SelectProviderResponse","ProviderType","Unselected","approve","selectedProviderKey","onApprove","watchAsset","type","symbol","decimals","image","inlineWatchAsset","WatchAssetReponse","addEthereumChain","rpcUrls","iconUrls","blockExplorerUrls","chainName","nativeCurrency","inlineAddEthereumChain","AddEthereumChainResponse","isApproved","rpcUrl","switchEthereumChain","custom","code","SwitchEthereumChainUnsupportedChainId","SwitchEthereumChainResponse","inlineSwitchEthereumChain","onSuccess","_nextSessionConfig","Set","default"],"sources":["C:/Users/USER/Documents/demo-react/node_modules/@coinbase/wallet-sdk/dist/relay/WalletSDKRelay.js"],"sourcesContent":["\"use strict\";\n// Copyright (c) 2018-2022 Coinbase, Inc. <https://www.coinbase.com/>\n// Licensed under the Apache License, version 2.0\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.WalletSDKRelay = void 0;\nconst bind_decorator_1 = __importDefault(require(\"bind-decorator\"));\nconst eth_rpc_errors_1 = require(\"eth-rpc-errors\");\nconst rxjs_1 = require(\"rxjs\");\nconst operators_1 = require(\"rxjs/operators\");\nconst DiagnosticLogger_1 = require(\"../connection/DiagnosticLogger\");\nconst WalletSDKConnection_1 = require(\"../connection/WalletSDKConnection\");\nconst WalletUIError_1 = require(\"../provider/WalletUIError\");\nconst types_1 = require(\"../types\");\nconst util_1 = require(\"../util\");\nconst aes256gcm = __importStar(require(\"./aes256gcm\"));\nconst Session_1 = require(\"./Session\");\nconst WalletSDKRelayAbstract_1 = require(\"./WalletSDKRelayAbstract\");\nconst Web3Method_1 = require(\"./Web3Method\");\nconst Web3RequestCanceledMessage_1 = require(\"./Web3RequestCanceledMessage\");\nconst Web3RequestMessage_1 = require(\"./Web3RequestMessage\");\nconst Web3Response_1 = require(\"./Web3Response\");\nconst Web3ResponseMessage_1 = require(\"./Web3ResponseMessage\");\nclass WalletSDKRelay extends WalletSDKRelayAbstract_1.WalletSDKRelayAbstract {\n    constructor(options) {\n        var _a;\n        super();\n        this.accountsCallback = null;\n        this.chainCallback = null;\n        this.dappDefaultChainSubject = new rxjs_1.BehaviorSubject(1);\n        this.dappDefaultChain = 1;\n        this.appName = \"\";\n        this.appLogoUrl = null;\n        this.subscriptions = new rxjs_1.Subscription();\n        this.linkAPIUrl = options.linkAPIUrl;\n        this.storage = options.storage;\n        this.options = options;\n        const { session, ui, connection } = this.subscribe();\n        this._session = session;\n        this.connection = connection;\n        this.relayEventManager = options.relayEventManager;\n        if (options.diagnosticLogger && options.eventListener) {\n            throw new Error(\"Can't have both eventListener and diagnosticLogger options, use only diagnosticLogger\");\n        }\n        if (options.eventListener) {\n            this.diagnostic = {\n                // eslint-disable-next-line @typescript-eslint/unbound-method\n                log: options.eventListener.onEvent,\n            };\n        }\n        else {\n            this.diagnostic = options.diagnosticLogger;\n        }\n        this._reloadOnDisconnect = (_a = options.reloadOnDisconnect) !== null && _a !== void 0 ? _a : true;\n        this.ui = ui;\n    }\n    subscribe() {\n        this.subscriptions.add(this.dappDefaultChainSubject.subscribe(chainId => {\n            if (this.dappDefaultChain !== chainId) {\n                this.dappDefaultChain = chainId;\n            }\n        }));\n        const session = Session_1.Session.load(this.storage) || new Session_1.Session(this.storage).save();\n        const connection = new WalletSDKConnection_1.WalletSDKConnection(session.id, session.key, this.linkAPIUrl, this.diagnostic);\n        this.subscriptions.add(connection.sessionConfig$.subscribe({\n            next: sessionConfig => {\n                this.onSessionConfigChanged(sessionConfig);\n            },\n            error: () => {\n                var _a;\n                (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n                    message: \"error while invoking session config callback\",\n                });\n            },\n        }));\n        this.subscriptions.add(connection.incomingEvent$\n            .pipe((0, operators_1.filter)(m => m.event === \"Web3Response\"))\n            .subscribe({ next: this.handleIncomingEvent }));\n        this.subscriptions.add(connection.linked$\n            .pipe((0, operators_1.skip)(1), (0, operators_1.tap)((linked) => {\n            var _a;\n            this.isLinked = linked;\n            const cachedAddresses = this.storage.getItem(WalletSDKRelayAbstract_1.LOCAL_STORAGE_ADDRESSES_KEY);\n            if (linked) {\n                // Only set linked session variable one way\n                this.session.linked = linked;\n            }\n            this.isUnlinkedErrorState = false;\n            if (cachedAddresses) {\n                const addresses = cachedAddresses.split(\" \");\n                const wasConnectedViaStandalone = this.storage.getItem(\"IsStandaloneSigning\") === \"true\";\n                if (addresses[0] !== \"\" &&\n                    !linked &&\n                    this.session.linked &&\n                    !wasConnectedViaStandalone) {\n                    this.isUnlinkedErrorState = true;\n                    const sessionIdHash = this.getSessionIdHash();\n                    (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.UNLINKED_ERROR_STATE, {\n                        sessionIdHash,\n                    });\n                }\n            }\n        }))\n            .subscribe());\n        // if session is marked destroyed, reset and reload\n        this.subscriptions.add(connection.sessionConfig$\n            .pipe((0, operators_1.filter)(c => !!c.metadata && c.metadata.__destroyed === \"1\"))\n            .subscribe(() => {\n            var _a;\n            const alreadyDestroyed = connection.isDestroyed;\n            (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.METADATA_DESTROYED, {\n                alreadyDestroyed,\n                sessionIdHash: this.getSessionIdHash(),\n            });\n            return this.resetAndReload();\n        }));\n        this.subscriptions.add(connection.sessionConfig$\n            .pipe((0, operators_1.filter)(c => c.metadata && c.metadata.WalletUsername !== undefined))\n            .pipe((0, operators_1.mergeMap)(c => aes256gcm.decrypt(c.metadata.WalletUsername, session.secret)))\n            .subscribe({\n            next: walletUsername => {\n                this.storage.setItem(WalletSDKRelayAbstract_1.WALLET_USER_NAME_KEY, walletUsername);\n            },\n            error: () => {\n                var _a;\n                (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n                    message: \"Had error decrypting\",\n                    value: \"username\",\n                });\n            },\n        }));\n        this.subscriptions.add(connection.sessionConfig$\n            .pipe((0, operators_1.filter)(c => c.metadata && c.metadata.AppVersion !== undefined))\n            .pipe((0, operators_1.mergeMap)(c => aes256gcm.decrypt(c.metadata.AppVersion, session.secret)))\n            .subscribe({\n            next: appVersion => {\n                this.storage.setItem(WalletSDKRelayAbstract_1.APP_VERSION_KEY, appVersion);\n            },\n            error: () => {\n                var _a;\n                (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n                    message: \"Had error decrypting\",\n                    value: \"appversion\",\n                });\n            },\n        }));\n        this.subscriptions.add(connection.sessionConfig$\n            .pipe((0, operators_1.filter)(c => c.metadata &&\n            c.metadata.ChainId !== undefined &&\n            c.metadata.JsonRpcUrl !== undefined))\n            .pipe((0, operators_1.mergeMap)(c => (0, rxjs_1.zip)(aes256gcm.decrypt(c.metadata.ChainId, session.secret), aes256gcm.decrypt(c.metadata.JsonRpcUrl, session.secret))))\n            .pipe((0, operators_1.distinctUntilChanged)())\n            .subscribe({\n            next: ([chainId, jsonRpcUrl]) => {\n                if (this.chainCallback) {\n                    this.chainCallback(chainId, jsonRpcUrl);\n                }\n            },\n            error: () => {\n                var _a;\n                (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n                    message: \"Had error decrypting\",\n                    value: \"chainId|jsonRpcUrl\",\n                });\n            },\n        }));\n        this.subscriptions.add(connection.sessionConfig$\n            .pipe((0, operators_1.filter)(c => c.metadata && c.metadata.EthereumAddress !== undefined))\n            .pipe((0, operators_1.mergeMap)(c => aes256gcm.decrypt(c.metadata.EthereumAddress, session.secret)))\n            .subscribe({\n            next: selectedAddress => {\n                if (this.accountsCallback) {\n                    this.accountsCallback([selectedAddress]);\n                }\n                if (WalletSDKRelay.accountRequestCallbackIds.size > 0) {\n                    // We get the ethereum address from the metadata.  If for whatever\n                    // reason we don't get a response via an explicit web3 message\n                    // we can still fulfill the eip1102 request.\n                    Array.from(WalletSDKRelay.accountRequestCallbackIds.values()).forEach(id => {\n                        const message = (0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                            id,\n                            response: (0, Web3Response_1.RequestEthereumAccountsResponse)([\n                                selectedAddress,\n                            ]),\n                        });\n                        this.invokeCallback(Object.assign(Object.assign({}, message), { id }));\n                    });\n                    WalletSDKRelay.accountRequestCallbackIds.clear();\n                }\n            },\n            error: () => {\n                var _a;\n                (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n                    message: \"Had error decrypting\",\n                    value: \"selectedAddress\",\n                });\n            },\n        }));\n        this.subscriptions.add(connection.sessionConfig$\n            .pipe((0, operators_1.filter)(c => c.metadata && c.metadata.AppSrc !== undefined))\n            .pipe((0, operators_1.mergeMap)(c => aes256gcm.decrypt(c.metadata.AppSrc, session.secret)))\n            .subscribe({\n            next: appSrc => {\n                this.ui.setAppSrc(appSrc);\n            },\n            error: () => {\n                var _a;\n                (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n                    message: \"Had error decrypting\",\n                    value: \"appSrc\",\n                });\n            },\n        }));\n        const ui = this.options.uiConstructor({\n            linkAPIUrl: this.options.linkAPIUrl,\n            version: this.options.version,\n            darkMode: this.options.darkMode,\n            session,\n            connected$: connection.connected$,\n            chainId$: this.dappDefaultChainSubject,\n        });\n        connection.connect();\n        return { session, ui, connection };\n    }\n    attachUI() {\n        this.ui.attach();\n    }\n    resetAndReload() {\n        this.connection\n            .setSessionMetadata(\"__destroyed\", \"1\")\n            .pipe((0, operators_1.timeout)(1000), (0, operators_1.catchError)(_ => (0, rxjs_1.of)(null)))\n            .subscribe(_ => {\n            var _a, _b, _c;\n            const isStandalone = this.ui.isStandalone();\n            try {\n                this.subscriptions.unsubscribe();\n            }\n            catch (err) {\n                (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n                    message: \"Had error unsubscribing\",\n                });\n            }\n            (_b = this.diagnostic) === null || _b === void 0 ? void 0 : _b.log(DiagnosticLogger_1.EVENTS.SESSION_STATE_CHANGE, {\n                method: \"relay::resetAndReload\",\n                sessionMetadataChange: \"__destroyed, 1\",\n                sessionIdHash: this.getSessionIdHash(),\n            });\n            this.connection.destroy();\n            /**\n             * Only clear storage if the session id we have in memory matches the one on disk\n             * Otherwise, in the case where we have 2 tabs, another tab might have cleared\n             * storage already.  In that case if we clear storage again, the user will be in\n             * a state where the first tab allows the user to connect but the session that\n             * was used isn't persisted.  This leaves the user in a state where they aren't\n             * connected to the mobile app.\n             */\n            const storedSession = Session_1.Session.load(this.storage);\n            if ((storedSession === null || storedSession === void 0 ? void 0 : storedSession.id) === this._session.id) {\n                this.storage.clear();\n            }\n            else if (storedSession) {\n                (_c = this.diagnostic) === null || _c === void 0 ? void 0 : _c.log(DiagnosticLogger_1.EVENTS.SKIPPED_CLEARING_SESSION, {\n                    sessionIdHash: this.getSessionIdHash(),\n                    storedSessionIdHash: Session_1.Session.hash(storedSession.id),\n                });\n            }\n            if (this._reloadOnDisconnect) {\n                this.ui.reloadUI();\n                return;\n            }\n            if (this.accountsCallback) {\n                this.accountsCallback([], true);\n            }\n            const { session, ui, connection } = this.subscribe();\n            this._session = session;\n            this.connection = connection;\n            this.ui = ui;\n            if (isStandalone && this.ui.setStandalone)\n                this.ui.setStandalone(true);\n            this.attachUI();\n        }, (err) => {\n            var _a;\n            (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.FAILURE, {\n                method: \"relay::resetAndReload\",\n                message: `failed to reset and reload with ${err}`,\n                sessionIdHash: this.getSessionIdHash(),\n            });\n        });\n    }\n    setAppInfo(appName, appLogoUrl) {\n        this.appName = appName;\n        this.appLogoUrl = appLogoUrl;\n    }\n    getStorageItem(key) {\n        return this.storage.getItem(key);\n    }\n    get session() {\n        return this._session;\n    }\n    setStorageItem(key, value) {\n        this.storage.setItem(key, value);\n    }\n    signEthereumMessage(message, address, addPrefix, typedDataJson) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumMessage,\n            params: {\n                message: (0, util_1.hexStringFromBuffer)(message, true),\n                address,\n                addPrefix,\n                typedDataJson: typedDataJson || null,\n            },\n        });\n    }\n    ethereumAddressFromSignedMessage(message, signature, addPrefix) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.ethereumAddressFromSignedMessage,\n            params: {\n                message: (0, util_1.hexStringFromBuffer)(message, true),\n                signature: (0, util_1.hexStringFromBuffer)(signature, true),\n                addPrefix,\n            },\n        });\n    }\n    signEthereumTransaction(params) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumTransaction,\n            params: {\n                fromAddress: params.fromAddress,\n                toAddress: params.toAddress,\n                weiValue: (0, util_1.bigIntStringFromBN)(params.weiValue),\n                data: (0, util_1.hexStringFromBuffer)(params.data, true),\n                nonce: params.nonce,\n                gasPriceInWei: params.gasPriceInWei\n                    ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei)\n                    : null,\n                maxFeePerGas: params.gasPriceInWei\n                    ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei)\n                    : null,\n                maxPriorityFeePerGas: params.gasPriceInWei\n                    ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei)\n                    : null,\n                gasLimit: params.gasLimit ? (0, util_1.bigIntStringFromBN)(params.gasLimit) : null,\n                chainId: params.chainId,\n                shouldSubmit: false,\n            },\n        });\n    }\n    signAndSubmitEthereumTransaction(params) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumTransaction,\n            params: {\n                fromAddress: params.fromAddress,\n                toAddress: params.toAddress,\n                weiValue: (0, util_1.bigIntStringFromBN)(params.weiValue),\n                data: (0, util_1.hexStringFromBuffer)(params.data, true),\n                nonce: params.nonce,\n                gasPriceInWei: params.gasPriceInWei\n                    ? (0, util_1.bigIntStringFromBN)(params.gasPriceInWei)\n                    : null,\n                maxFeePerGas: params.maxFeePerGas\n                    ? (0, util_1.bigIntStringFromBN)(params.maxFeePerGas)\n                    : null,\n                maxPriorityFeePerGas: params.maxPriorityFeePerGas\n                    ? (0, util_1.bigIntStringFromBN)(params.maxPriorityFeePerGas)\n                    : null,\n                gasLimit: params.gasLimit ? (0, util_1.bigIntStringFromBN)(params.gasLimit) : null,\n                chainId: params.chainId,\n                shouldSubmit: true,\n            },\n        });\n    }\n    submitEthereumTransaction(signedTransaction, chainId) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.submitEthereumTransaction,\n            params: {\n                signedTransaction: (0, util_1.hexStringFromBuffer)(signedTransaction, true),\n                chainId,\n            },\n        });\n    }\n    scanQRCode(regExp) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.scanQRCode,\n            params: { regExp },\n        });\n    }\n    getQRCodeUrl() {\n        return (0, util_1.createQrUrl)(this._session.id, this._session.secret, this.linkAPIUrl, false, this.options.version, this.dappDefaultChain);\n    }\n    genericRequest(data, action) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.generic,\n            params: {\n                action,\n                data,\n            },\n        });\n    }\n    sendGenericMessage(request) {\n        return this.sendRequest(request);\n    }\n    sendRequest(request) {\n        let hideSnackbarItem = null;\n        const id = (0, util_1.randomBytesHex)(8);\n        const cancel = (error) => {\n            this.publishWeb3RequestCanceledEvent(id);\n            this.handleErrorResponse(id, request.method, error);\n            hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n        };\n        const promise = new Promise((resolve, reject) => {\n            if (!this.ui.isStandalone()) {\n                hideSnackbarItem = this.ui.showConnecting({\n                    isUnlinkedErrorState: this.isUnlinkedErrorState,\n                    onCancel: cancel,\n                    onResetConnection: this.resetAndReload, // eslint-disable-line @typescript-eslint/unbound-method\n                });\n            }\n            this.relayEventManager.callbacks.set(id, response => {\n                hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n                if (response.errorMessage) {\n                    return reject(new Error(response.errorMessage));\n                }\n                resolve(response);\n            });\n            if (this.ui.isStandalone()) {\n                this.sendRequestStandalone(id, request);\n            }\n            else {\n                this.publishWeb3RequestEvent(id, request);\n            }\n        });\n        return { promise, cancel };\n    }\n    setConnectDisabled(disabled) {\n        this.ui.setConnectDisabled(disabled);\n    }\n    setAccountsCallback(accountsCallback) {\n        this.accountsCallback = accountsCallback;\n    }\n    setChainCallback(chainCallback) {\n        this.chainCallback = chainCallback;\n    }\n    setDappDefaultChainCallback(chainId) {\n        this.dappDefaultChainSubject.next(chainId);\n    }\n    publishWeb3RequestEvent(id, request) {\n        var _a;\n        const message = (0, Web3RequestMessage_1.Web3RequestMessage)({ id, request });\n        const storedSession = Session_1.Session.load(this.storage);\n        (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.WEB3_REQUEST, {\n            eventId: message.id,\n            method: `relay::${message.request.method}`,\n            sessionIdHash: this.getSessionIdHash(),\n            storedSessionIdHash: storedSession ? Session_1.Session.hash(storedSession.id) : \"\",\n            isSessionMismatched: ((storedSession === null || storedSession === void 0 ? void 0 : storedSession.id) !== this._session.id).toString(),\n        });\n        this.subscriptions.add(this.publishEvent(\"Web3Request\", message, true).subscribe({\n            next: _ => {\n                var _a;\n                (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.WEB3_REQUEST_PUBLISHED, {\n                    eventId: message.id,\n                    method: `relay::${message.request.method}`,\n                    sessionIdHash: this.getSessionIdHash(),\n                    storedSessionIdHash: storedSession\n                        ? Session_1.Session.hash(storedSession.id)\n                        : \"\",\n                    isSessionMismatched: ((storedSession === null || storedSession === void 0 ? void 0 : storedSession.id) !== this._session.id).toString(),\n                });\n            },\n            error: err => {\n                this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                    id: message.id,\n                    response: {\n                        method: message.request.method,\n                        errorMessage: err.message,\n                    },\n                }));\n            },\n        }));\n    }\n    publishWeb3RequestCanceledEvent(id) {\n        const message = (0, Web3RequestCanceledMessage_1.Web3RequestCanceledMessage)(id);\n        this.subscriptions.add(this.publishEvent(\"Web3RequestCanceled\", message, false).subscribe());\n    }\n    publishEvent(event, message, callWebhook) {\n        const secret = this.session.secret;\n        return new rxjs_1.Observable(subscriber => {\n            void aes256gcm\n                .encrypt(JSON.stringify(Object.assign(Object.assign({}, message), { origin: location.origin })), secret)\n                .then((encrypted) => {\n                subscriber.next(encrypted);\n                subscriber.complete();\n            });\n        }).pipe((0, operators_1.mergeMap)((encrypted) => {\n            return this.connection.publishEvent(event, encrypted, callWebhook);\n        }));\n    }\n    handleIncomingEvent(event) {\n        try {\n            this.subscriptions.add(aes256gcm\n                .decrypt(event.data, this.session.secret)\n                .pipe((0, operators_1.map)(c => JSON.parse(c)))\n                .subscribe({\n                next: json => {\n                    const message = (0, Web3ResponseMessage_1.isWeb3ResponseMessage)(json) ? json : null;\n                    if (!message) {\n                        return;\n                    }\n                    this.handleWeb3ResponseMessage(message);\n                },\n                error: () => {\n                    var _a;\n                    (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.GENERAL_ERROR, {\n                        message: \"Had error decrypting\",\n                        value: \"incomingEvent\",\n                    });\n                },\n            }));\n        }\n        catch (_a) {\n            return;\n        }\n    }\n    handleWeb3ResponseMessage(message) {\n        var _a;\n        const { response } = message;\n        (_a = this.diagnostic) === null || _a === void 0 ? void 0 : _a.log(DiagnosticLogger_1.EVENTS.WEB3_RESPONSE, {\n            eventId: message.id,\n            method: `relay::${response.method}`,\n            sessionIdHash: this.getSessionIdHash(),\n        });\n        if ((0, Web3Response_1.isRequestEthereumAccountsResponse)(response)) {\n            WalletSDKRelay.accountRequestCallbackIds.forEach(id => this.invokeCallback(Object.assign(Object.assign({}, message), { id })));\n            WalletSDKRelay.accountRequestCallbackIds.clear();\n            return;\n        }\n        this.invokeCallback(message);\n    }\n    handleErrorResponse(id, method, error, errorCode) {\n        this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n            id,\n            response: (0, Web3Response_1.ErrorResponse)(method, (error !== null && error !== void 0 ? error : WalletUIError_1.WalletUIError.UserRejectedRequest).message, errorCode),\n        }));\n    }\n    invokeCallback(message) {\n        const callback = this.relayEventManager.callbacks.get(message.id);\n        if (callback) {\n            callback(message.response);\n            this.relayEventManager.callbacks.delete(message.id);\n        }\n    }\n    requestEthereumAccounts() {\n        const request = {\n            method: Web3Method_1.Web3Method.requestEthereumAccounts,\n            params: {\n                appName: this.appName,\n                appLogoUrl: this.appLogoUrl || null,\n            },\n        };\n        const hideSnackbarItem = null;\n        const id = (0, util_1.randomBytesHex)(8);\n        const cancel = (error) => {\n            this.publishWeb3RequestCanceledEvent(id);\n            this.handleErrorResponse(id, request.method, error);\n            // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n            // @ts-ignore\n            hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n        };\n        const promise = new Promise((resolve, reject) => {\n            var _a;\n            this.relayEventManager.callbacks.set(id, response => {\n                this.ui.hideRequestEthereumAccounts();\n                // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n                // @ts-ignore\n                hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n                if (response.errorMessage) {\n                    return reject(new Error(response.errorMessage));\n                }\n                resolve(response);\n            });\n            const userAgent = ((_a = window === null || window === void 0 ? void 0 : window.navigator) === null || _a === void 0 ? void 0 : _a.userAgent) || null;\n            if (userAgent &&\n                /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)) {\n                let location;\n                try {\n                    if ((0, util_1.isInIFrame)() && window.top) {\n                        location = window.top.location;\n                    }\n                    else {\n                        location = window.location;\n                    }\n                }\n                catch (e) {\n                    location = window.location;\n                }\n                location.href = `https://www.coinbase.com/connect-dapp?uri=${encodeURIComponent(location.href)}`;\n                return;\n            }\n            if (this.ui.inlineAccountsResponse()) {\n                const onAccounts = (accounts) => {\n                    this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                        id,\n                        response: (0, Web3Response_1.RequestEthereumAccountsResponse)(accounts),\n                    }));\n                };\n                this.ui.requestEthereumAccounts({\n                    onCancel: cancel,\n                    onAccounts,\n                });\n            }\n            else {\n                // Error if user closes TryExtensionLinkDialog without connecting\n                const err = eth_rpc_errors_1.ethErrors.provider.userRejectedRequest(\"User denied account authorization\");\n                this.ui.requestEthereumAccounts({\n                    onCancel: () => cancel(err),\n                });\n            }\n            WalletSDKRelay.accountRequestCallbackIds.add(id);\n            if (!this.ui.inlineAccountsResponse() && !this.ui.isStandalone()) {\n                this.publishWeb3RequestEvent(id, request);\n            }\n        });\n        return { promise, cancel };\n    }\n    selectProvider(providerOptions) {\n        const request = {\n            method: Web3Method_1.Web3Method.selectProvider,\n            params: {\n                providerOptions,\n            },\n        };\n        const id = (0, util_1.randomBytesHex)(8);\n        const cancel = (error) => {\n            this.publishWeb3RequestCanceledEvent(id);\n            this.handleErrorResponse(id, request.method, error);\n        };\n        const promise = new Promise((resolve, reject) => {\n            this.relayEventManager.callbacks.set(id, response => {\n                if (response.errorMessage) {\n                    return reject(new Error(response.errorMessage));\n                }\n                resolve(response);\n            });\n            const _cancel = (_error) => {\n                this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                    id,\n                    response: (0, Web3Response_1.SelectProviderResponse)(types_1.ProviderType.Unselected),\n                }));\n            };\n            const approve = (selectedProviderKey) => {\n                this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                    id,\n                    response: (0, Web3Response_1.SelectProviderResponse)(selectedProviderKey),\n                }));\n            };\n            if (this.ui.selectProvider)\n                this.ui.selectProvider({\n                    onApprove: approve,\n                    onCancel: _cancel,\n                    providerOptions,\n                });\n        });\n        return { cancel, promise };\n    }\n    watchAsset(type, address, symbol, decimals, image, chainId) {\n        const request = {\n            method: Web3Method_1.Web3Method.watchAsset,\n            params: {\n                type,\n                options: {\n                    address,\n                    symbol,\n                    decimals,\n                    image,\n                },\n                chainId,\n            },\n        };\n        let hideSnackbarItem = null;\n        const id = (0, util_1.randomBytesHex)(8);\n        const cancel = (error) => {\n            this.publishWeb3RequestCanceledEvent(id);\n            this.handleErrorResponse(id, request.method, error);\n            hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n        };\n        if (!this.ui.inlineWatchAsset()) {\n            hideSnackbarItem = this.ui.showConnecting({\n                isUnlinkedErrorState: this.isUnlinkedErrorState,\n                onCancel: cancel,\n                onResetConnection: this.resetAndReload, // eslint-disable-line @typescript-eslint/unbound-method\n            });\n        }\n        const promise = new Promise((resolve, reject) => {\n            this.relayEventManager.callbacks.set(id, response => {\n                hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n                if (response.errorMessage) {\n                    return reject(new Error(response.errorMessage));\n                }\n                resolve(response);\n            });\n            const _cancel = (_error) => {\n                this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                    id,\n                    response: (0, Web3Response_1.WatchAssetReponse)(false),\n                }));\n            };\n            const approve = () => {\n                this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                    id,\n                    response: (0, Web3Response_1.WatchAssetReponse)(true),\n                }));\n            };\n            if (this.ui.inlineWatchAsset()) {\n                this.ui.watchAsset({\n                    onApprove: approve,\n                    onCancel: _cancel,\n                    type,\n                    address,\n                    symbol,\n                    decimals,\n                    image,\n                    chainId,\n                });\n            }\n            if (!this.ui.inlineWatchAsset() && !this.ui.isStandalone()) {\n                this.publishWeb3RequestEvent(id, request);\n            }\n        });\n        return { cancel, promise };\n    }\n    addEthereumChain(chainId, rpcUrls, iconUrls, blockExplorerUrls, chainName, nativeCurrency) {\n        const request = {\n            method: Web3Method_1.Web3Method.addEthereumChain,\n            params: {\n                chainId,\n                rpcUrls,\n                blockExplorerUrls,\n                chainName,\n                iconUrls,\n                nativeCurrency,\n            },\n        };\n        let hideSnackbarItem = null;\n        const id = (0, util_1.randomBytesHex)(8);\n        const cancel = (error) => {\n            this.publishWeb3RequestCanceledEvent(id);\n            this.handleErrorResponse(id, request.method, error);\n            hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n        };\n        if (!this.ui.inlineAddEthereumChain(chainId)) {\n            hideSnackbarItem = this.ui.showConnecting({\n                isUnlinkedErrorState: this.isUnlinkedErrorState,\n                onCancel: cancel,\n                onResetConnection: this.resetAndReload, // eslint-disable-line @typescript-eslint/unbound-method\n            });\n        }\n        const promise = new Promise((resolve, reject) => {\n            this.relayEventManager.callbacks.set(id, response => {\n                hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n                if (response.errorMessage) {\n                    return reject(new Error(response.errorMessage));\n                }\n                resolve(response);\n            });\n            const _cancel = (_error) => {\n                this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                    id,\n                    response: (0, Web3Response_1.AddEthereumChainResponse)({\n                        isApproved: false,\n                        rpcUrl: \"\",\n                    }),\n                }));\n            };\n            const approve = (rpcUrl) => {\n                this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                    id,\n                    response: (0, Web3Response_1.AddEthereumChainResponse)({ isApproved: true, rpcUrl }),\n                }));\n            };\n            if (this.ui.inlineAddEthereumChain(chainId)) {\n                this.ui.addEthereumChain({\n                    onCancel: _cancel,\n                    onApprove: approve,\n                    chainId: request.params.chainId,\n                    rpcUrls: request.params.rpcUrls,\n                    blockExplorerUrls: request.params.blockExplorerUrls,\n                    chainName: request.params.chainName,\n                    iconUrls: request.params.iconUrls,\n                    nativeCurrency: request.params.nativeCurrency,\n                });\n            }\n            if (!this.ui.inlineAddEthereumChain(chainId) && !this.ui.isStandalone()) {\n                this.publishWeb3RequestEvent(id, request);\n            }\n        });\n        return { promise, cancel };\n    }\n    switchEthereumChain(chainId, address) {\n        const request = {\n            method: Web3Method_1.Web3Method.switchEthereumChain,\n            params: Object.assign({ chainId }, { address }),\n        };\n        const id = (0, util_1.randomBytesHex)(8);\n        const cancel = (error) => {\n            this.publishWeb3RequestCanceledEvent(id);\n            this.handleErrorResponse(id, request.method, error);\n        };\n        const promise = new Promise((resolve, reject) => {\n            this.relayEventManager.callbacks.set(id, response => {\n                if (response.errorMessage && response.errorCode) {\n                    return reject(eth_rpc_errors_1.ethErrors.provider.custom({\n                        code: response.errorCode,\n                        message: `Unrecognized chain ID. Try adding the chain using addEthereumChain first.`,\n                    }));\n                }\n                else if (response.errorMessage) {\n                    return reject(new Error(response.errorMessage));\n                }\n                resolve(response);\n            });\n            const _cancel = (error) => {\n                if (typeof error === \"number\") {\n                    // backward compatibility\n                    const errorCode = error;\n                    this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                        id,\n                        response: (0, Web3Response_1.ErrorResponse)(Web3Method_1.Web3Method.switchEthereumChain, WalletUIError_1.WalletUIError.SwitchEthereumChainUnsupportedChainId.message, errorCode),\n                    }));\n                }\n                else if (error instanceof WalletUIError_1.WalletUIError) {\n                    this.handleErrorResponse(id, Web3Method_1.Web3Method.switchEthereumChain, error, error.errorCode);\n                }\n                else {\n                    this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                        id,\n                        response: (0, Web3Response_1.SwitchEthereumChainResponse)({\n                            isApproved: false,\n                            rpcUrl: \"\",\n                        }),\n                    }));\n                }\n            };\n            const approve = (rpcUrl) => {\n                this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                    id,\n                    response: (0, Web3Response_1.SwitchEthereumChainResponse)({\n                        isApproved: true,\n                        rpcUrl,\n                    }),\n                }));\n            };\n            this.ui.switchEthereumChain({\n                onCancel: _cancel,\n                onApprove: approve,\n                chainId: request.params.chainId,\n                address: request.params.address,\n            });\n            if (!this.ui.inlineSwitchEthereumChain() && !this.ui.isStandalone()) {\n                this.publishWeb3RequestEvent(id, request);\n            }\n        });\n        return { promise, cancel };\n    }\n    inlineAddEthereumChain(chainId) {\n        return this.ui.inlineAddEthereumChain(chainId);\n    }\n    getSessionIdHash() {\n        return Session_1.Session.hash(this._session.id);\n    }\n    sendRequestStandalone(id, request) {\n        const _cancel = (error) => {\n            this.handleErrorResponse(id, request.method, error);\n        };\n        const onSuccess = (response) => {\n            this.handleWeb3ResponseMessage((0, Web3ResponseMessage_1.Web3ResponseMessage)({\n                id,\n                response,\n            }));\n        };\n        switch (request.method) {\n            case Web3Method_1.Web3Method.signEthereumMessage:\n                this.ui.signEthereumMessage({\n                    request,\n                    onSuccess,\n                    onCancel: _cancel,\n                });\n                break;\n            case Web3Method_1.Web3Method.signEthereumTransaction:\n                this.ui.signEthereumTransaction({\n                    request,\n                    onSuccess,\n                    onCancel: _cancel,\n                });\n                break;\n            case Web3Method_1.Web3Method.submitEthereumTransaction:\n                this.ui.submitEthereumTransaction({\n                    request,\n                    onSuccess,\n                    onCancel: _cancel,\n                });\n                break;\n            case Web3Method_1.Web3Method.ethereumAddressFromSignedMessage:\n                this.ui.ethereumAddressFromSignedMessage({\n                    request,\n                    onSuccess,\n                });\n                break;\n            default:\n                _cancel();\n                break;\n        }\n    }\n    onSessionConfigChanged(_nextSessionConfig) { }\n}\nWalletSDKRelay.accountRequestCallbackIds = new Set();\n__decorate([\n    bind_decorator_1.default\n], WalletSDKRelay.prototype, \"resetAndReload\", null);\n__decorate([\n    bind_decorator_1.default\n], WalletSDKRelay.prototype, \"handleIncomingEvent\", null);\nexports.WalletSDKRelay = WalletSDKRelay;\n"],"mappings":"AAAA,a,CACA;AACA;;AACA,IAAIA,eAAe,GAAI,QAAQ,KAAKA,eAAd,KAAmCC,MAAM,CAACC,MAAP,GAAiB,UAASC,CAAT,EAAYC,CAAZ,EAAeC,CAAf,EAAkBC,EAAlB,EAAsB;EAC5F,IAAIA,EAAE,KAAKC,SAAX,EAAsBD,EAAE,GAAGD,CAAL;EACtBJ,MAAM,CAACO,cAAP,CAAsBL,CAAtB,EAAyBG,EAAzB,EAA6B;IAAEG,UAAU,EAAE,IAAd;IAAoBC,GAAG,EAAE,YAAW;MAAE,OAAON,CAAC,CAACC,CAAD,CAAR;IAAc;EAApD,CAA7B;AACH,CAHwD,GAGnD,UAASF,CAAT,EAAYC,CAAZ,EAAeC,CAAf,EAAkBC,EAAlB,EAAsB;EACxB,IAAIA,EAAE,KAAKC,SAAX,EAAsBD,EAAE,GAAGD,CAAL;EACtBF,CAAC,CAACG,EAAD,CAAD,GAAQF,CAAC,CAACC,CAAD,CAAT;AACH,CANqB,CAAtB;;AAOA,IAAIM,kBAAkB,GAAI,QAAQ,KAAKA,kBAAd,KAAsCV,MAAM,CAACC,MAAP,GAAiB,UAASC,CAAT,EAAYS,CAAZ,EAAe;EAC3FX,MAAM,CAACO,cAAP,CAAsBL,CAAtB,EAAyB,SAAzB,EAAoC;IAAEM,UAAU,EAAE,IAAd;IAAoBI,KAAK,EAAED;EAA3B,CAApC;AACH,CAF8D,GAE1D,UAAST,CAAT,EAAYS,CAAZ,EAAe;EAChBT,CAAC,CAAC,SAAD,CAAD,GAAeS,CAAf;AACH,CAJwB,CAAzB;;AAKA,IAAIE,UAAU,GAAI,QAAQ,KAAKA,UAAd,IAA6B,UAAUC,UAAV,EAAsBC,MAAtB,EAA8BC,GAA9B,EAAmCC,IAAnC,EAAyC;EACnF,IAAIC,CAAC,GAAGC,SAAS,CAACC,MAAlB;EAAA,IAA0BC,CAAC,GAAGH,CAAC,GAAG,CAAJ,GAAQH,MAAR,GAAiBE,IAAI,KAAK,IAAT,GAAgBA,IAAI,GAAGjB,MAAM,CAACsB,wBAAP,CAAgCP,MAAhC,EAAwCC,GAAxC,CAAvB,GAAsEC,IAArH;EAAA,IAA2HM,CAA3H;EACA,IAAI,OAAOC,OAAP,KAAmB,QAAnB,IAA+B,OAAOA,OAAO,CAACC,QAAf,KAA4B,UAA/D,EAA2EJ,CAAC,GAAGG,OAAO,CAACC,QAAR,CAAiBX,UAAjB,EAA6BC,MAA7B,EAAqCC,GAArC,EAA0CC,IAA1C,CAAJ,CAA3E,KACK,KAAK,IAAIS,CAAC,GAAGZ,UAAU,CAACM,MAAX,GAAoB,CAAjC,EAAoCM,CAAC,IAAI,CAAzC,EAA4CA,CAAC,EAA7C,EAAiD,IAAIH,CAAC,GAAGT,UAAU,CAACY,CAAD,CAAlB,EAAuBL,CAAC,GAAG,CAACH,CAAC,GAAG,CAAJ,GAAQK,CAAC,CAACF,CAAD,CAAT,GAAeH,CAAC,GAAG,CAAJ,GAAQK,CAAC,CAACR,MAAD,EAASC,GAAT,EAAcK,CAAd,CAAT,GAA4BE,CAAC,CAACR,MAAD,EAASC,GAAT,CAA7C,KAA+DK,CAAnE;EAC7E,OAAOH,CAAC,GAAG,CAAJ,IAASG,CAAT,IAAcrB,MAAM,CAACO,cAAP,CAAsBQ,MAAtB,EAA8BC,GAA9B,EAAmCK,CAAnC,CAAd,EAAqDA,CAA5D;AACH,CALD;;AAMA,IAAIM,YAAY,GAAI,QAAQ,KAAKA,YAAd,IAA+B,UAAUC,GAAV,EAAe;EAC7D,IAAIA,GAAG,IAAIA,GAAG,CAACC,UAAf,EAA2B,OAAOD,GAAP;EAC3B,IAAIE,MAAM,GAAG,EAAb;EACA,IAAIF,GAAG,IAAI,IAAX,EAAiB,KAAK,IAAIxB,CAAT,IAAcwB,GAAd,EAAmB,IAAIxB,CAAC,KAAK,SAAN,IAAmBJ,MAAM,CAAC+B,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCL,GAArC,EAA0CxB,CAA1C,CAAvB,EAAqEL,eAAe,CAAC+B,MAAD,EAASF,GAAT,EAAcxB,CAAd,CAAf;;EACzGM,kBAAkB,CAACoB,MAAD,EAASF,GAAT,CAAlB;;EACA,OAAOE,MAAP;AACH,CAND;;AAOA,IAAII,eAAe,GAAI,QAAQ,KAAKA,eAAd,IAAkC,UAAUN,GAAV,EAAe;EACnE,OAAQA,GAAG,IAAIA,GAAG,CAACC,UAAZ,GAA0BD,GAA1B,GAAgC;IAAE,WAAWA;EAAb,CAAvC;AACH,CAFD;;AAGA5B,MAAM,CAACO,cAAP,CAAsB4B,OAAtB,EAA+B,YAA/B,EAA6C;EAAEvB,KAAK,EAAE;AAAT,CAA7C;AACAuB,OAAO,CAACC,cAAR,GAAyB,KAAK,CAA9B;;AACA,MAAMC,gBAAgB,GAAGH,eAAe,CAACI,OAAO,CAAC,gBAAD,CAAR,CAAxC;;AACA,MAAMC,gBAAgB,GAAGD,OAAO,CAAC,gBAAD,CAAhC;;AACA,MAAME,MAAM,GAAGF,OAAO,CAAC,MAAD,CAAtB;;AACA,MAAMG,WAAW,GAAGH,OAAO,CAAC,gBAAD,CAA3B;;AACA,MAAMI,kBAAkB,GAAGJ,OAAO,CAAC,gCAAD,CAAlC;;AACA,MAAMK,qBAAqB,GAAGL,OAAO,CAAC,mCAAD,CAArC;;AACA,MAAMM,eAAe,GAAGN,OAAO,CAAC,2BAAD,CAA/B;;AACA,MAAMO,OAAO,GAAGP,OAAO,CAAC,UAAD,CAAvB;;AACA,MAAMQ,MAAM,GAAGR,OAAO,CAAC,SAAD,CAAtB;;AACA,MAAMS,SAAS,GAAGpB,YAAY,CAACW,OAAO,CAAC,aAAD,CAAR,CAA9B;;AACA,MAAMU,SAAS,GAAGV,OAAO,CAAC,WAAD,CAAzB;;AACA,MAAMW,wBAAwB,GAAGX,OAAO,CAAC,0BAAD,CAAxC;;AACA,MAAMY,YAAY,GAAGZ,OAAO,CAAC,cAAD,CAA5B;;AACA,MAAMa,4BAA4B,GAAGb,OAAO,CAAC,8BAAD,CAA5C;;AACA,MAAMc,oBAAoB,GAAGd,OAAO,CAAC,sBAAD,CAApC;;AACA,MAAMe,cAAc,GAAGf,OAAO,CAAC,gBAAD,CAA9B;;AACA,MAAMgB,qBAAqB,GAAGhB,OAAO,CAAC,uBAAD,CAArC;;AACA,MAAMF,cAAN,SAA6Ba,wBAAwB,CAACM,sBAAtD,CAA6E;EACzEC,WAAW,CAACC,OAAD,EAAU;IACjB,IAAIC,EAAJ;;IACA;IACA,KAAKC,gBAAL,GAAwB,IAAxB;IACA,KAAKC,aAAL,GAAqB,IAArB;IACA,KAAKC,uBAAL,GAA+B,IAAIrB,MAAM,CAACsB,eAAX,CAA2B,CAA3B,CAA/B;IACA,KAAKC,gBAAL,GAAwB,CAAxB;IACA,KAAKC,OAAL,GAAe,EAAf;IACA,KAAKC,UAAL,GAAkB,IAAlB;IACA,KAAKC,aAAL,GAAqB,IAAI1B,MAAM,CAAC2B,YAAX,EAArB;IACA,KAAKC,UAAL,GAAkBX,OAAO,CAACW,UAA1B;IACA,KAAKC,OAAL,GAAeZ,OAAO,CAACY,OAAvB;IACA,KAAKZ,OAAL,GAAeA,OAAf;IACA,MAAM;MAAEa,OAAF;MAAWC,EAAX;MAAeC;IAAf,IAA8B,KAAKC,SAAL,EAApC;IACA,KAAKC,QAAL,GAAgBJ,OAAhB;IACA,KAAKE,UAAL,GAAkBA,UAAlB;IACA,KAAKG,iBAAL,GAAyBlB,OAAO,CAACkB,iBAAjC;;IACA,IAAIlB,OAAO,CAACmB,gBAAR,IAA4BnB,OAAO,CAACoB,aAAxC,EAAuD;MACnD,MAAM,IAAIC,KAAJ,CAAU,uFAAV,CAAN;IACH;;IACD,IAAIrB,OAAO,CAACoB,aAAZ,EAA2B;MACvB,KAAKE,UAAL,GAAkB;QACd;QACAC,GAAG,EAAEvB,OAAO,CAACoB,aAAR,CAAsBI;MAFb,CAAlB;IAIH,CALD,MAMK;MACD,KAAKF,UAAL,GAAkBtB,OAAO,CAACmB,gBAA1B;IACH;;IACD,KAAKM,mBAAL,GAA2B,CAACxB,EAAE,GAAGD,OAAO,CAAC0B,kBAAd,MAAsC,IAAtC,IAA8CzB,EAAE,KAAK,KAAK,CAA1D,GAA8DA,EAA9D,GAAmE,IAA9F;IACA,KAAKa,EAAL,GAAUA,EAAV;EACH;;EACDE,SAAS,GAAG;IACR,KAAKP,aAAL,CAAmBkB,GAAnB,CAAuB,KAAKvB,uBAAL,CAA6BY,SAA7B,CAAuCY,OAAO,IAAI;MACrE,IAAI,KAAKtB,gBAAL,KAA0BsB,OAA9B,EAAuC;QACnC,KAAKtB,gBAAL,GAAwBsB,OAAxB;MACH;IACJ,CAJsB,CAAvB;IAKA,MAAMf,OAAO,GAAGtB,SAAS,CAACsC,OAAV,CAAkBC,IAAlB,CAAuB,KAAKlB,OAA5B,KAAwC,IAAIrB,SAAS,CAACsC,OAAd,CAAsB,KAAKjB,OAA3B,EAAoCmB,IAApC,EAAxD;IACA,MAAMhB,UAAU,GAAG,IAAI7B,qBAAqB,CAAC8C,mBAA1B,CAA8CnB,OAAO,CAACoB,EAAtD,EAA0DpB,OAAO,CAACtD,GAAlE,EAAuE,KAAKoD,UAA5E,EAAwF,KAAKW,UAA7F,CAAnB;IACA,KAAKb,aAAL,CAAmBkB,GAAnB,CAAuBZ,UAAU,CAACmB,cAAX,CAA0BlB,SAA1B,CAAoC;MACvDmB,IAAI,EAAEC,aAAa,IAAI;QACnB,KAAKC,sBAAL,CAA4BD,aAA5B;MACH,CAHsD;MAIvDE,KAAK,EAAE,MAAM;QACT,IAAIrC,EAAJ;;QACA,CAACA,EAAE,GAAG,KAAKqB,UAAX,MAA2B,IAA3B,IAAmCrB,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACsB,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0BC,aAAjC,EAAgD;UACxGC,OAAO,EAAE;QAD+F,CAAhD,CAA5D;MAGH;IATsD,CAApC,CAAvB;IAWA,KAAKhC,aAAL,CAAmBkB,GAAnB,CAAuBZ,UAAU,CAAC2B,cAAX,CAClBC,IADkB,CACb,CAAC,GAAG3D,WAAW,CAAC4D,MAAhB,EAAwBlG,CAAC,IAAIA,CAAC,CAACmG,KAAF,KAAY,cAAzC,CADa,EAElB7B,SAFkB,CAER;MAAEmB,IAAI,EAAE,KAAKW;IAAb,CAFQ,CAAvB;IAGA,KAAKrC,aAAL,CAAmBkB,GAAnB,CAAuBZ,UAAU,CAACgC,OAAX,CAClBJ,IADkB,CACb,CAAC,GAAG3D,WAAW,CAACgE,IAAhB,EAAsB,CAAtB,CADa,EACa,CAAC,GAAGhE,WAAW,CAACiE,GAAhB,EAAsBC,MAAD,IAAY;MACjE,IAAIjD,EAAJ;;MACA,KAAKkD,QAAL,GAAgBD,MAAhB;MACA,MAAME,eAAe,GAAG,KAAKxC,OAAL,CAAayC,OAAb,CAAqB7D,wBAAwB,CAAC8D,2BAA9C,CAAxB;;MACA,IAAIJ,MAAJ,EAAY;QACR;QACA,KAAKrC,OAAL,CAAaqC,MAAb,GAAsBA,MAAtB;MACH;;MACD,KAAKK,oBAAL,GAA4B,KAA5B;;MACA,IAAIH,eAAJ,EAAqB;QACjB,MAAMI,SAAS,GAAGJ,eAAe,CAACK,KAAhB,CAAsB,GAAtB,CAAlB;QACA,MAAMC,yBAAyB,GAAG,KAAK9C,OAAL,CAAayC,OAAb,CAAqB,qBAArB,MAAgD,MAAlF;;QACA,IAAIG,SAAS,CAAC,CAAD,CAAT,KAAiB,EAAjB,IACA,CAACN,MADD,IAEA,KAAKrC,OAAL,CAAaqC,MAFb,IAGA,CAACQ,yBAHL,EAGgC;UAC5B,KAAKH,oBAAL,GAA4B,IAA5B;UACA,MAAMI,aAAa,GAAG,KAAKC,gBAAL,EAAtB;UACA,CAAC3D,EAAE,GAAG,KAAKqB,UAAX,MAA2B,IAA3B,IAAmCrB,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACsB,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0BsB,oBAAjC,EAAuD;YAC/GF;UAD+G,CAAvD,CAA5D;QAGH;MACJ;IACJ,CAvBmC,CADb,EAyBlB3C,SAzBkB,EAAvB,EAtBQ,CAgDR;;IACA,KAAKP,aAAL,CAAmBkB,GAAnB,CAAuBZ,UAAU,CAACmB,cAAX,CAClBS,IADkB,CACb,CAAC,GAAG3D,WAAW,CAAC4D,MAAhB,EAAwBnF,CAAC,IAAI,CAAC,CAACA,CAAC,CAACqG,QAAJ,IAAgBrG,CAAC,CAACqG,QAAF,CAAWC,WAAX,KAA2B,GAAxE,CADa,EAElB/C,SAFkB,CAER,MAAM;MACjB,IAAIf,EAAJ;;MACA,MAAM+D,gBAAgB,GAAGjD,UAAU,CAACkD,WAApC;MACA,CAAChE,EAAE,GAAG,KAAKqB,UAAX,MAA2B,IAA3B,IAAmCrB,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACsB,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0B2B,kBAAjC,EAAqD;QAC7GF,gBAD6G;QAE7GL,aAAa,EAAE,KAAKC,gBAAL;MAF8F,CAArD,CAA5D;MAIA,OAAO,KAAKO,cAAL,EAAP;IACH,CAVsB,CAAvB;IAWA,KAAK1D,aAAL,CAAmBkB,GAAnB,CAAuBZ,UAAU,CAACmB,cAAX,CAClBS,IADkB,CACb,CAAC,GAAG3D,WAAW,CAAC4D,MAAhB,EAAwBnF,CAAC,IAAIA,CAAC,CAACqG,QAAF,IAAcrG,CAAC,CAACqG,QAAF,CAAWM,cAAX,KAA8BvH,SAAzE,CADa,EAElB8F,IAFkB,CAEb,CAAC,GAAG3D,WAAW,CAACqF,QAAhB,EAA0B5G,CAAC,IAAI6B,SAAS,CAACgF,OAAV,CAAkB7G,CAAC,CAACqG,QAAF,CAAWM,cAA7B,EAA6CvD,OAAO,CAAC0D,MAArD,CAA/B,CAFa,EAGlBvD,SAHkB,CAGR;MACXmB,IAAI,EAAEqC,cAAc,IAAI;QACpB,KAAK5D,OAAL,CAAa6D,OAAb,CAAqBjF,wBAAwB,CAACkF,oBAA9C,EAAoEF,cAApE;MACH,CAHU;MAIXlC,KAAK,EAAE,MAAM;QACT,IAAIrC,EAAJ;;QACA,CAACA,EAAE,GAAG,KAAKqB,UAAX,MAA2B,IAA3B,IAAmCrB,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACsB,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0BC,aAAjC,EAAgD;UACxGC,OAAO,EAAE,sBAD+F;UAExGtF,KAAK,EAAE;QAFiG,CAAhD,CAA5D;MAIH;IAVU,CAHQ,CAAvB;IAeA,KAAKsD,aAAL,CAAmBkB,GAAnB,CAAuBZ,UAAU,CAACmB,cAAX,CAClBS,IADkB,CACb,CAAC,GAAG3D,WAAW,CAAC4D,MAAhB,EAAwBnF,CAAC,IAAIA,CAAC,CAACqG,QAAF,IAAcrG,CAAC,CAACqG,QAAF,CAAWa,UAAX,KAA0B9H,SAArE,CADa,EAElB8F,IAFkB,CAEb,CAAC,GAAG3D,WAAW,CAACqF,QAAhB,EAA0B5G,CAAC,IAAI6B,SAAS,CAACgF,OAAV,CAAkB7G,CAAC,CAACqG,QAAF,CAAWa,UAA7B,EAAyC9D,OAAO,CAAC0D,MAAjD,CAA/B,CAFa,EAGlBvD,SAHkB,CAGR;MACXmB,IAAI,EAAEyC,UAAU,IAAI;QAChB,KAAKhE,OAAL,CAAa6D,OAAb,CAAqBjF,wBAAwB,CAACqF,eAA9C,EAA+DD,UAA/D;MACH,CAHU;MAIXtC,KAAK,EAAE,MAAM;QACT,IAAIrC,EAAJ;;QACA,CAACA,EAAE,GAAG,KAAKqB,UAAX,MAA2B,IAA3B,IAAmCrB,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACsB,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0BC,aAAjC,EAAgD;UACxGC,OAAO,EAAE,sBAD+F;UAExGtF,KAAK,EAAE;QAFiG,CAAhD,CAA5D;MAIH;IAVU,CAHQ,CAAvB;IAeA,KAAKsD,aAAL,CAAmBkB,GAAnB,CAAuBZ,UAAU,CAACmB,cAAX,CAClBS,IADkB,CACb,CAAC,GAAG3D,WAAW,CAAC4D,MAAhB,EAAwBnF,CAAC,IAAIA,CAAC,CAACqG,QAAF,IACnCrG,CAAC,CAACqG,QAAF,CAAWgB,OAAX,KAAuBjI,SADY,IAEnCY,CAAC,CAACqG,QAAF,CAAWiB,UAAX,KAA0BlI,SAFpB,CADa,EAIlB8F,IAJkB,CAIb,CAAC,GAAG3D,WAAW,CAACqF,QAAhB,EAA0B5G,CAAC,IAAI,CAAC,GAAGsB,MAAM,CAACiG,GAAX,EAAgB1F,SAAS,CAACgF,OAAV,CAAkB7G,CAAC,CAACqG,QAAF,CAAWgB,OAA7B,EAAsCjE,OAAO,CAAC0D,MAA9C,CAAhB,EAAuEjF,SAAS,CAACgF,OAAV,CAAkB7G,CAAC,CAACqG,QAAF,CAAWiB,UAA7B,EAAyClE,OAAO,CAAC0D,MAAjD,CAAvE,CAA/B,CAJa,EAKlB5B,IALkB,CAKb,CAAC,GAAG3D,WAAW,CAACiG,oBAAhB,GALa,EAMlBjE,SANkB,CAMR;MACXmB,IAAI,EAAE,QAA2B;QAAA,IAA1B,CAACP,OAAD,EAAUsD,UAAV,CAA0B;;QAC7B,IAAI,KAAK/E,aAAT,EAAwB;UACpB,KAAKA,aAAL,CAAmByB,OAAnB,EAA4BsD,UAA5B;QACH;MACJ,CALU;MAMX5C,KAAK,EAAE,MAAM;QACT,IAAIrC,EAAJ;;QACA,CAACA,EAAE,GAAG,KAAKqB,UAAX,MAA2B,IAA3B,IAAmCrB,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACsB,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0BC,aAAjC,EAAgD;UACxGC,OAAO,EAAE,sBAD+F;UAExGtF,KAAK,EAAE;QAFiG,CAAhD,CAA5D;MAIH;IAZU,CANQ,CAAvB;IAoBA,KAAKsD,aAAL,CAAmBkB,GAAnB,CAAuBZ,UAAU,CAACmB,cAAX,CAClBS,IADkB,CACb,CAAC,GAAG3D,WAAW,CAAC4D,MAAhB,EAAwBnF,CAAC,IAAIA,CAAC,CAACqG,QAAF,IAAcrG,CAAC,CAACqG,QAAF,CAAWqB,eAAX,KAA+BtI,SAA1E,CADa,EAElB8F,IAFkB,CAEb,CAAC,GAAG3D,WAAW,CAACqF,QAAhB,EAA0B5G,CAAC,IAAI6B,SAAS,CAACgF,OAAV,CAAkB7G,CAAC,CAACqG,QAAF,CAAWqB,eAA7B,EAA8CtE,OAAO,CAAC0D,MAAtD,CAA/B,CAFa,EAGlBvD,SAHkB,CAGR;MACXmB,IAAI,EAAEiD,eAAe,IAAI;QACrB,IAAI,KAAKlF,gBAAT,EAA2B;UACvB,KAAKA,gBAAL,CAAsB,CAACkF,eAAD,CAAtB;QACH;;QACD,IAAIzG,cAAc,CAAC0G,yBAAf,CAAyCC,IAAzC,GAAgD,CAApD,EAAuD;UACnD;UACA;UACA;UACAC,KAAK,CAACC,IAAN,CAAW7G,cAAc,CAAC0G,yBAAf,CAAyCI,MAAzC,EAAX,EAA8DC,OAA9D,CAAsEzD,EAAE,IAAI;YACxE,MAAMQ,OAAO,GAAG,CAAC,GAAG5C,qBAAqB,CAAC8F,mBAA1B,EAA+C;cAC3D1D,EAD2D;cAE3D2D,QAAQ,EAAE,CAAC,GAAGhG,cAAc,CAACiG,+BAAnB,EAAoD,CAC1DT,eAD0D,CAApD;YAFiD,CAA/C,CAAhB;YAMA,KAAKU,cAAL,CAAoBvJ,MAAM,CAACwJ,MAAP,CAAcxJ,MAAM,CAACwJ,MAAP,CAAc,EAAd,EAAkBtD,OAAlB,CAAd,EAA0C;cAAER;YAAF,CAA1C,CAApB;UACH,CARD;UASAtD,cAAc,CAAC0G,yBAAf,CAAyCW,KAAzC;QACH;MACJ,CApBU;MAqBX1D,KAAK,EAAE,MAAM;QACT,IAAIrC,EAAJ;;QACA,CAACA,EAAE,GAAG,KAAKqB,UAAX,MAA2B,IAA3B,IAAmCrB,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACsB,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0BC,aAAjC,EAAgD;UACxGC,OAAO,EAAE,sBAD+F;UAExGtF,KAAK,EAAE;QAFiG,CAAhD,CAA5D;MAIH;IA3BU,CAHQ,CAAvB;IAgCA,KAAKsD,aAAL,CAAmBkB,GAAnB,CAAuBZ,UAAU,CAACmB,cAAX,CAClBS,IADkB,CACb,CAAC,GAAG3D,WAAW,CAAC4D,MAAhB,EAAwBnF,CAAC,IAAIA,CAAC,CAACqG,QAAF,IAAcrG,CAAC,CAACqG,QAAF,CAAWmC,MAAX,KAAsBpJ,SAAjE,CADa,EAElB8F,IAFkB,CAEb,CAAC,GAAG3D,WAAW,CAACqF,QAAhB,EAA0B5G,CAAC,IAAI6B,SAAS,CAACgF,OAAV,CAAkB7G,CAAC,CAACqG,QAAF,CAAWmC,MAA7B,EAAqCpF,OAAO,CAAC0D,MAA7C,CAA/B,CAFa,EAGlBvD,SAHkB,CAGR;MACXmB,IAAI,EAAE+D,MAAM,IAAI;QACZ,KAAKpF,EAAL,CAAQqF,SAAR,CAAkBD,MAAlB;MACH,CAHU;MAIX5D,KAAK,EAAE,MAAM;QACT,IAAIrC,EAAJ;;QACA,CAACA,EAAE,GAAG,KAAKqB,UAAX,MAA2B,IAA3B,IAAmCrB,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACsB,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0BC,aAAjC,EAAgD;UACxGC,OAAO,EAAE,sBAD+F;UAExGtF,KAAK,EAAE;QAFiG,CAAhD,CAA5D;MAIH;IAVU,CAHQ,CAAvB;IAeA,MAAM2D,EAAE,GAAG,KAAKd,OAAL,CAAaoG,aAAb,CAA2B;MAClCzF,UAAU,EAAE,KAAKX,OAAL,CAAaW,UADS;MAElC0F,OAAO,EAAE,KAAKrG,OAAL,CAAaqG,OAFY;MAGlCC,QAAQ,EAAE,KAAKtG,OAAL,CAAasG,QAHW;MAIlCzF,OAJkC;MAKlC0F,UAAU,EAAExF,UAAU,CAACwF,UALW;MAMlCC,QAAQ,EAAE,KAAKpG;IANmB,CAA3B,CAAX;IAQAW,UAAU,CAAC0F,OAAX;IACA,OAAO;MAAE5F,OAAF;MAAWC,EAAX;MAAeC;IAAf,CAAP;EACH;;EACD2F,QAAQ,GAAG;IACP,KAAK5F,EAAL,CAAQ6F,MAAR;EACH;;EACDxC,cAAc,GAAG;IACb,KAAKpD,UAAL,CACK6F,kBADL,CACwB,aADxB,EACuC,GADvC,EAEKjE,IAFL,CAEU,CAAC,GAAG3D,WAAW,CAAC6H,OAAhB,EAAyB,IAAzB,CAFV,EAE0C,CAAC,GAAG7H,WAAW,CAAC8H,UAAhB,EAA4BC,CAAC,IAAI,CAAC,GAAGhI,MAAM,CAACiI,EAAX,EAAe,IAAf,CAAjC,CAF1C,EAGKhG,SAHL,CAGe+F,CAAC,IAAI;MAChB,IAAI9G,EAAJ,EAAQgH,EAAR,EAAYC,EAAZ;;MACA,MAAMC,YAAY,GAAG,KAAKrG,EAAL,CAAQqG,YAAR,EAArB;;MACA,IAAI;QACA,KAAK1G,aAAL,CAAmB2G,WAAnB;MACH,CAFD,CAGA,OAAOC,GAAP,EAAY;QACR,CAACpH,EAAE,GAAG,KAAKqB,UAAX,MAA2B,IAA3B,IAAmCrB,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACsB,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0BC,aAAjC,EAAgD;UACxGC,OAAO,EAAE;QAD+F,CAAhD,CAA5D;MAGH;;MACD,CAACwE,EAAE,GAAG,KAAK3F,UAAX,MAA2B,IAA3B,IAAmC2F,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAAC1F,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0B+E,oBAAjC,EAAuD;QAC/GC,MAAM,EAAE,uBADuG;QAE/GC,qBAAqB,EAAE,gBAFwF;QAG/G7D,aAAa,EAAE,KAAKC,gBAAL;MAHgG,CAAvD,CAA5D;MAKA,KAAK7C,UAAL,CAAgB0G,OAAhB;MACA;AACZ;AACA;AACA;AACA;AACA;AACA;AACA;;MACY,MAAMC,aAAa,GAAGnI,SAAS,CAACsC,OAAV,CAAkBC,IAAlB,CAAuB,KAAKlB,OAA5B,CAAtB;;MACA,IAAI,CAAC8G,aAAa,KAAK,IAAlB,IAA0BA,aAAa,KAAK,KAAK,CAAjD,GAAqD,KAAK,CAA1D,GAA8DA,aAAa,CAACzF,EAA7E,MAAqF,KAAKhB,QAAL,CAAcgB,EAAvG,EAA2G;QACvG,KAAKrB,OAAL,CAAaoF,KAAb;MACH,CAFD,MAGK,IAAI0B,aAAJ,EAAmB;QACpB,CAACR,EAAE,GAAG,KAAK5F,UAAX,MAA2B,IAA3B,IAAmC4F,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAAC3F,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0BoF,wBAAjC,EAA2D;UACnHhE,aAAa,EAAE,KAAKC,gBAAL,EADoG;UAEnHgE,mBAAmB,EAAErI,SAAS,CAACsC,OAAV,CAAkBgG,IAAlB,CAAuBH,aAAa,CAACzF,EAArC;QAF8F,CAA3D,CAA5D;MAIH;;MACD,IAAI,KAAKR,mBAAT,EAA8B;QAC1B,KAAKX,EAAL,CAAQgH,QAAR;QACA;MACH;;MACD,IAAI,KAAK5H,gBAAT,EAA2B;QACvB,KAAKA,gBAAL,CAAsB,EAAtB,EAA0B,IAA1B;MACH;;MACD,MAAM;QAAEW,OAAF;QAAWC,EAAX;QAAeC;MAAf,IAA8B,KAAKC,SAAL,EAApC;MACA,KAAKC,QAAL,GAAgBJ,OAAhB;MACA,KAAKE,UAAL,GAAkBA,UAAlB;MACA,KAAKD,EAAL,GAAUA,EAAV;MACA,IAAIqG,YAAY,IAAI,KAAKrG,EAAL,CAAQiH,aAA5B,EACI,KAAKjH,EAAL,CAAQiH,aAAR,CAAsB,IAAtB;MACJ,KAAKrB,QAAL;IACH,CApDD,EAoDIW,GAAD,IAAS;MACR,IAAIpH,EAAJ;;MACA,CAACA,EAAE,GAAG,KAAKqB,UAAX,MAA2B,IAA3B,IAAmCrB,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACsB,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0ByF,OAAjC,EAA0C;QAClGT,MAAM,EAAE,uBAD0F;QAElG9E,OAAO,EAAG,mCAAkC4E,GAAI,EAFkD;QAGlG1D,aAAa,EAAE,KAAKC,gBAAL;MAHmF,CAA1C,CAA5D;IAKH,CA3DD;EA4DH;;EACDqE,UAAU,CAAC1H,OAAD,EAAUC,UAAV,EAAsB;IAC5B,KAAKD,OAAL,GAAeA,OAAf;IACA,KAAKC,UAAL,GAAkBA,UAAlB;EACH;;EACD0H,cAAc,CAAC3K,GAAD,EAAM;IAChB,OAAO,KAAKqD,OAAL,CAAayC,OAAb,CAAqB9F,GAArB,CAAP;EACH;;EACU,IAAPsD,OAAO,GAAG;IACV,OAAO,KAAKI,QAAZ;EACH;;EACDkH,cAAc,CAAC5K,GAAD,EAAMJ,KAAN,EAAa;IACvB,KAAKyD,OAAL,CAAa6D,OAAb,CAAqBlH,GAArB,EAA0BJ,KAA1B;EACH;;EACDiL,mBAAmB,CAAC3F,OAAD,EAAU4F,OAAV,EAAmBC,SAAnB,EAA8BC,aAA9B,EAA6C;IAC5D,OAAO,KAAKC,WAAL,CAAiB;MACpBjB,MAAM,EAAE9H,YAAY,CAACgJ,UAAb,CAAwBL,mBADZ;MAEpBM,MAAM,EAAE;QACJjG,OAAO,EAAE,CAAC,GAAGpD,MAAM,CAACsJ,mBAAX,EAAgClG,OAAhC,EAAyC,IAAzC,CADL;QAEJ4F,OAFI;QAGJC,SAHI;QAIJC,aAAa,EAAEA,aAAa,IAAI;MAJ5B;IAFY,CAAjB,CAAP;EASH;;EACDK,gCAAgC,CAACnG,OAAD,EAAUoG,SAAV,EAAqBP,SAArB,EAAgC;IAC5D,OAAO,KAAKE,WAAL,CAAiB;MACpBjB,MAAM,EAAE9H,YAAY,CAACgJ,UAAb,CAAwBG,gCADZ;MAEpBF,MAAM,EAAE;QACJjG,OAAO,EAAE,CAAC,GAAGpD,MAAM,CAACsJ,mBAAX,EAAgClG,OAAhC,EAAyC,IAAzC,CADL;QAEJoG,SAAS,EAAE,CAAC,GAAGxJ,MAAM,CAACsJ,mBAAX,EAAgCE,SAAhC,EAA2C,IAA3C,CAFP;QAGJP;MAHI;IAFY,CAAjB,CAAP;EAQH;;EACDQ,uBAAuB,CAACJ,MAAD,EAAS;IAC5B,OAAO,KAAKF,WAAL,CAAiB;MACpBjB,MAAM,EAAE9H,YAAY,CAACgJ,UAAb,CAAwBK,uBADZ;MAEpBJ,MAAM,EAAE;QACJK,WAAW,EAAEL,MAAM,CAACK,WADhB;QAEJC,SAAS,EAAEN,MAAM,CAACM,SAFd;QAGJC,QAAQ,EAAE,CAAC,GAAG5J,MAAM,CAAC6J,kBAAX,EAA+BR,MAAM,CAACO,QAAtC,CAHN;QAIJE,IAAI,EAAE,CAAC,GAAG9J,MAAM,CAACsJ,mBAAX,EAAgCD,MAAM,CAACS,IAAvC,EAA6C,IAA7C,CAJF;QAKJC,KAAK,EAAEV,MAAM,CAACU,KALV;QAMJC,aAAa,EAAEX,MAAM,CAACW,aAAP,GACT,CAAC,GAAGhK,MAAM,CAAC6J,kBAAX,EAA+BR,MAAM,CAACW,aAAtC,CADS,GAET,IARF;QASJC,YAAY,EAAEZ,MAAM,CAACW,aAAP,GACR,CAAC,GAAGhK,MAAM,CAAC6J,kBAAX,EAA+BR,MAAM,CAACW,aAAtC,CADQ,GAER,IAXF;QAYJE,oBAAoB,EAAEb,MAAM,CAACW,aAAP,GAChB,CAAC,GAAGhK,MAAM,CAAC6J,kBAAX,EAA+BR,MAAM,CAACW,aAAtC,CADgB,GAEhB,IAdF;QAeJG,QAAQ,EAAEd,MAAM,CAACc,QAAP,GAAkB,CAAC,GAAGnK,MAAM,CAAC6J,kBAAX,EAA+BR,MAAM,CAACc,QAAtC,CAAlB,GAAoE,IAf1E;QAgBJ5H,OAAO,EAAE8G,MAAM,CAAC9G,OAhBZ;QAiBJ6H,YAAY,EAAE;MAjBV;IAFY,CAAjB,CAAP;EAsBH;;EACDC,gCAAgC,CAAChB,MAAD,EAAS;IACrC,OAAO,KAAKF,WAAL,CAAiB;MACpBjB,MAAM,EAAE9H,YAAY,CAACgJ,UAAb,CAAwBK,uBADZ;MAEpBJ,MAAM,EAAE;QACJK,WAAW,EAAEL,MAAM,CAACK,WADhB;QAEJC,SAAS,EAAEN,MAAM,CAACM,SAFd;QAGJC,QAAQ,EAAE,CAAC,GAAG5J,MAAM,CAAC6J,kBAAX,EAA+BR,MAAM,CAACO,QAAtC,CAHN;QAIJE,IAAI,EAAE,CAAC,GAAG9J,MAAM,CAACsJ,mBAAX,EAAgCD,MAAM,CAACS,IAAvC,EAA6C,IAA7C,CAJF;QAKJC,KAAK,EAAEV,MAAM,CAACU,KALV;QAMJC,aAAa,EAAEX,MAAM,CAACW,aAAP,GACT,CAAC,GAAGhK,MAAM,CAAC6J,kBAAX,EAA+BR,MAAM,CAACW,aAAtC,CADS,GAET,IARF;QASJC,YAAY,EAAEZ,MAAM,CAACY,YAAP,GACR,CAAC,GAAGjK,MAAM,CAAC6J,kBAAX,EAA+BR,MAAM,CAACY,YAAtC,CADQ,GAER,IAXF;QAYJC,oBAAoB,EAAEb,MAAM,CAACa,oBAAP,GAChB,CAAC,GAAGlK,MAAM,CAAC6J,kBAAX,EAA+BR,MAAM,CAACa,oBAAtC,CADgB,GAEhB,IAdF;QAeJC,QAAQ,EAAEd,MAAM,CAACc,QAAP,GAAkB,CAAC,GAAGnK,MAAM,CAAC6J,kBAAX,EAA+BR,MAAM,CAACc,QAAtC,CAAlB,GAAoE,IAf1E;QAgBJ5H,OAAO,EAAE8G,MAAM,CAAC9G,OAhBZ;QAiBJ6H,YAAY,EAAE;MAjBV;IAFY,CAAjB,CAAP;EAsBH;;EACDE,yBAAyB,CAACC,iBAAD,EAAoBhI,OAApB,EAA6B;IAClD,OAAO,KAAK4G,WAAL,CAAiB;MACpBjB,MAAM,EAAE9H,YAAY,CAACgJ,UAAb,CAAwBkB,yBADZ;MAEpBjB,MAAM,EAAE;QACJkB,iBAAiB,EAAE,CAAC,GAAGvK,MAAM,CAACsJ,mBAAX,EAAgCiB,iBAAhC,EAAmD,IAAnD,CADf;QAEJhI;MAFI;IAFY,CAAjB,CAAP;EAOH;;EACDiI,UAAU,CAACC,MAAD,EAAS;IACf,OAAO,KAAKtB,WAAL,CAAiB;MACpBjB,MAAM,EAAE9H,YAAY,CAACgJ,UAAb,CAAwBoB,UADZ;MAEpBnB,MAAM,EAAE;QAAEoB;MAAF;IAFY,CAAjB,CAAP;EAIH;;EACDC,YAAY,GAAG;IACX,OAAO,CAAC,GAAG1K,MAAM,CAAC2K,WAAX,EAAwB,KAAK/I,QAAL,CAAcgB,EAAtC,EAA0C,KAAKhB,QAAL,CAAcsD,MAAxD,EAAgE,KAAK5D,UAArE,EAAiF,KAAjF,EAAwF,KAAKX,OAAL,CAAaqG,OAArG,EAA8G,KAAK/F,gBAAnH,CAAP;EACH;;EACD2J,cAAc,CAACd,IAAD,EAAOe,MAAP,EAAe;IACzB,OAAO,KAAK1B,WAAL,CAAiB;MACpBjB,MAAM,EAAE9H,YAAY,CAACgJ,UAAb,CAAwB0B,OADZ;MAEpBzB,MAAM,EAAE;QACJwB,MADI;QAEJf;MAFI;IAFY,CAAjB,CAAP;EAOH;;EACDiB,kBAAkB,CAACC,OAAD,EAAU;IACxB,OAAO,KAAK7B,WAAL,CAAiB6B,OAAjB,CAAP;EACH;;EACD7B,WAAW,CAAC6B,OAAD,EAAU;IACjB,IAAIC,gBAAgB,GAAG,IAAvB;IACA,MAAMrI,EAAE,GAAG,CAAC,GAAG5C,MAAM,CAACkL,cAAX,EAA2B,CAA3B,CAAX;;IACA,MAAMC,MAAM,GAAIlI,KAAD,IAAW;MACtB,KAAKmI,+BAAL,CAAqCxI,EAArC;MACA,KAAKyI,mBAAL,CAAyBzI,EAAzB,EAA6BoI,OAAO,CAAC9C,MAArC,EAA6CjF,KAA7C;MACAgI,gBAAgB,KAAK,IAArB,IAA6BA,gBAAgB,KAAK,KAAK,CAAvD,GAA2D,KAAK,CAAhE,GAAoEA,gBAAgB,EAApF;IACH,CAJD;;IAKA,MAAMK,OAAO,GAAG,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;MAC7C,IAAI,CAAC,KAAKhK,EAAL,CAAQqG,YAAR,EAAL,EAA6B;QACzBmD,gBAAgB,GAAG,KAAKxJ,EAAL,CAAQiK,cAAR,CAAuB;UACtCxH,oBAAoB,EAAE,KAAKA,oBADW;UAEtCyH,QAAQ,EAAER,MAF4B;UAGtCS,iBAAiB,EAAE,KAAK9G,cAHc,CAGE;;QAHF,CAAvB,CAAnB;MAKH;;MACD,KAAKjD,iBAAL,CAAuBgK,SAAvB,CAAiCC,GAAjC,CAAqClJ,EAArC,EAAyC2D,QAAQ,IAAI;QACjD0E,gBAAgB,KAAK,IAArB,IAA6BA,gBAAgB,KAAK,KAAK,CAAvD,GAA2D,KAAK,CAAhE,GAAoEA,gBAAgB,EAApF;;QACA,IAAI1E,QAAQ,CAACwF,YAAb,EAA2B;UACvB,OAAON,MAAM,CAAC,IAAIzJ,KAAJ,CAAUuE,QAAQ,CAACwF,YAAnB,CAAD,CAAb;QACH;;QACDP,OAAO,CAACjF,QAAD,CAAP;MACH,CAND;;MAOA,IAAI,KAAK9E,EAAL,CAAQqG,YAAR,EAAJ,EAA4B;QACxB,KAAKkE,qBAAL,CAA2BpJ,EAA3B,EAA+BoI,OAA/B;MACH,CAFD,MAGK;QACD,KAAKiB,uBAAL,CAA6BrJ,EAA7B,EAAiCoI,OAAjC;MACH;IACJ,CArBe,CAAhB;IAsBA,OAAO;MAAEM,OAAF;MAAWH;IAAX,CAAP;EACH;;EACDe,kBAAkB,CAACC,QAAD,EAAW;IACzB,KAAK1K,EAAL,CAAQyK,kBAAR,CAA2BC,QAA3B;EACH;;EACDC,mBAAmB,CAACvL,gBAAD,EAAmB;IAClC,KAAKA,gBAAL,GAAwBA,gBAAxB;EACH;;EACDwL,gBAAgB,CAACvL,aAAD,EAAgB;IAC5B,KAAKA,aAAL,GAAqBA,aAArB;EACH;;EACDwL,2BAA2B,CAAC/J,OAAD,EAAU;IACjC,KAAKxB,uBAAL,CAA6B+B,IAA7B,CAAkCP,OAAlC;EACH;;EACD0J,uBAAuB,CAACrJ,EAAD,EAAKoI,OAAL,EAAc;IACjC,IAAIpK,EAAJ;;IACA,MAAMwC,OAAO,GAAG,CAAC,GAAG9C,oBAAoB,CAACiM,kBAAzB,EAA6C;MAAE3J,EAAF;MAAMoI;IAAN,CAA7C,CAAhB;IACA,MAAM3C,aAAa,GAAGnI,SAAS,CAACsC,OAAV,CAAkBC,IAAlB,CAAuB,KAAKlB,OAA5B,CAAtB;IACA,CAACX,EAAE,GAAG,KAAKqB,UAAX,MAA2B,IAA3B,IAAmCrB,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACsB,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0BsJ,YAAjC,EAA+C;MACvGC,OAAO,EAAErJ,OAAO,CAACR,EADsF;MAEvGsF,MAAM,EAAG,UAAS9E,OAAO,CAAC4H,OAAR,CAAgB9C,MAAO,EAF8D;MAGvG5D,aAAa,EAAE,KAAKC,gBAAL,EAHwF;MAIvGgE,mBAAmB,EAAEF,aAAa,GAAGnI,SAAS,CAACsC,OAAV,CAAkBgG,IAAlB,CAAuBH,aAAa,CAACzF,EAArC,CAAH,GAA8C,EAJuB;MAKvG8J,mBAAmB,EAAE,CAAC,CAACrE,aAAa,KAAK,IAAlB,IAA0BA,aAAa,KAAK,KAAK,CAAjD,GAAqD,KAAK,CAA1D,GAA8DA,aAAa,CAACzF,EAA7E,MAAqF,KAAKhB,QAAL,CAAcgB,EAApG,EAAwG+J,QAAxG;IALkF,CAA/C,CAA5D;IAOA,KAAKvL,aAAL,CAAmBkB,GAAnB,CAAuB,KAAKsK,YAAL,CAAkB,aAAlB,EAAiCxJ,OAAjC,EAA0C,IAA1C,EAAgDzB,SAAhD,CAA0D;MAC7EmB,IAAI,EAAE4E,CAAC,IAAI;QACP,IAAI9G,EAAJ;;QACA,CAACA,EAAE,GAAG,KAAKqB,UAAX,MAA2B,IAA3B,IAAmCrB,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACsB,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0B2J,sBAAjC,EAAyD;UACjHJ,OAAO,EAAErJ,OAAO,CAACR,EADgG;UAEjHsF,MAAM,EAAG,UAAS9E,OAAO,CAAC4H,OAAR,CAAgB9C,MAAO,EAFwE;UAGjH5D,aAAa,EAAE,KAAKC,gBAAL,EAHkG;UAIjHgE,mBAAmB,EAAEF,aAAa,GAC5BnI,SAAS,CAACsC,OAAV,CAAkBgG,IAAlB,CAAuBH,aAAa,CAACzF,EAArC,CAD4B,GAE5B,EAN2G;UAOjH8J,mBAAmB,EAAE,CAAC,CAACrE,aAAa,KAAK,IAAlB,IAA0BA,aAAa,KAAK,KAAK,CAAjD,GAAqD,KAAK,CAA1D,GAA8DA,aAAa,CAACzF,EAA7E,MAAqF,KAAKhB,QAAL,CAAcgB,EAApG,EAAwG+J,QAAxG;QAP4F,CAAzD,CAA5D;MASH,CAZ4E;MAa7E1J,KAAK,EAAE+E,GAAG,IAAI;QACV,KAAK8E,yBAAL,CAA+B,CAAC,GAAGtM,qBAAqB,CAAC8F,mBAA1B,EAA+C;UAC1E1D,EAAE,EAAEQ,OAAO,CAACR,EAD8D;UAE1E2D,QAAQ,EAAE;YACN2B,MAAM,EAAE9E,OAAO,CAAC4H,OAAR,CAAgB9C,MADlB;YAEN6D,YAAY,EAAE/D,GAAG,CAAC5E;UAFZ;QAFgE,CAA/C,CAA/B;MAOH;IArB4E,CAA1D,CAAvB;EAuBH;;EACDgI,+BAA+B,CAACxI,EAAD,EAAK;IAChC,MAAMQ,OAAO,GAAG,CAAC,GAAG/C,4BAA4B,CAAC0M,0BAAjC,EAA6DnK,EAA7D,CAAhB;IACA,KAAKxB,aAAL,CAAmBkB,GAAnB,CAAuB,KAAKsK,YAAL,CAAkB,qBAAlB,EAAyCxJ,OAAzC,EAAkD,KAAlD,EAAyDzB,SAAzD,EAAvB;EACH;;EACDiL,YAAY,CAACpJ,KAAD,EAAQJ,OAAR,EAAiB4J,WAAjB,EAA8B;IACtC,MAAM9H,MAAM,GAAG,KAAK1D,OAAL,CAAa0D,MAA5B;IACA,OAAO,IAAIxF,MAAM,CAACuN,UAAX,CAAsBC,UAAU,IAAI;MACvC,KAAKjN,SAAS,CACTkN,OADA,CACQC,IAAI,CAACC,SAAL,CAAenQ,MAAM,CAACwJ,MAAP,CAAcxJ,MAAM,CAACwJ,MAAP,CAAc,EAAd,EAAkBtD,OAAlB,CAAd,EAA0C;QAAEkK,MAAM,EAAEC,QAAQ,CAACD;MAAnB,CAA1C,CAAf,CADR,EACgGpI,MADhG,EAEAsI,IAFA,CAEMC,SAAD,IAAe;QACrBP,UAAU,CAACpK,IAAX,CAAgB2K,SAAhB;QACAP,UAAU,CAACQ,QAAX;MACH,CALI,CAAL;IAMH,CAPM,EAOJpK,IAPI,CAOC,CAAC,GAAG3D,WAAW,CAACqF,QAAhB,EAA2ByI,SAAD,IAAe;MAC7C,OAAO,KAAK/L,UAAL,CAAgBkL,YAAhB,CAA6BpJ,KAA7B,EAAoCiK,SAApC,EAA+CT,WAA/C,CAAP;IACH,CAFO,CAPD,CAAP;EAUH;;EACDvJ,mBAAmB,CAACD,KAAD,EAAQ;IACvB,IAAI;MACA,KAAKpC,aAAL,CAAmBkB,GAAnB,CAAuBrC,SAAS,CAC3BgF,OADkB,CACVzB,KAAK,CAACsG,IADI,EACE,KAAKtI,OAAL,CAAa0D,MADf,EAElB5B,IAFkB,CAEb,CAAC,GAAG3D,WAAW,CAACgO,GAAhB,EAAqBvP,CAAC,IAAIgP,IAAI,CAACQ,KAAL,CAAWxP,CAAX,CAA1B,CAFa,EAGlBuD,SAHkB,CAGR;QACXmB,IAAI,EAAE+K,IAAI,IAAI;UACV,MAAMzK,OAAO,GAAG,CAAC,GAAG5C,qBAAqB,CAACsN,qBAA1B,EAAiDD,IAAjD,IAAyDA,IAAzD,GAAgE,IAAhF;;UACA,IAAI,CAACzK,OAAL,EAAc;YACV;UACH;;UACD,KAAK0J,yBAAL,CAA+B1J,OAA/B;QACH,CAPU;QAQXH,KAAK,EAAE,MAAM;UACT,IAAIrC,EAAJ;;UACA,CAACA,EAAE,GAAG,KAAKqB,UAAX,MAA2B,IAA3B,IAAmCrB,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACsB,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0BC,aAAjC,EAAgD;YACxGC,OAAO,EAAE,sBAD+F;YAExGtF,KAAK,EAAE;UAFiG,CAAhD,CAA5D;QAIH;MAdU,CAHQ,CAAvB;IAmBH,CApBD,CAqBA,OAAO8C,EAAP,EAAW;MACP;IACH;EACJ;;EACDkM,yBAAyB,CAAC1J,OAAD,EAAU;IAC/B,IAAIxC,EAAJ;;IACA,MAAM;MAAE2F;IAAF,IAAenD,OAArB;IACA,CAACxC,EAAE,GAAG,KAAKqB,UAAX,MAA2B,IAA3B,IAAmCrB,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACsB,GAAH,CAAOtC,kBAAkB,CAACsD,MAAnB,CAA0B6K,aAAjC,EAAgD;MACxGtB,OAAO,EAAErJ,OAAO,CAACR,EADuF;MAExGsF,MAAM,EAAG,UAAS3B,QAAQ,CAAC2B,MAAO,EAFsE;MAGxG5D,aAAa,EAAE,KAAKC,gBAAL;IAHyF,CAAhD,CAA5D;;IAKA,IAAI,CAAC,GAAGhE,cAAc,CAACyN,iCAAnB,EAAsDzH,QAAtD,CAAJ,EAAqE;MACjEjH,cAAc,CAAC0G,yBAAf,CAAyCK,OAAzC,CAAiDzD,EAAE,IAAI,KAAK6D,cAAL,CAAoBvJ,MAAM,CAACwJ,MAAP,CAAcxJ,MAAM,CAACwJ,MAAP,CAAc,EAAd,EAAkBtD,OAAlB,CAAd,EAA0C;QAAER;MAAF,CAA1C,CAApB,CAAvD;MACAtD,cAAc,CAAC0G,yBAAf,CAAyCW,KAAzC;MACA;IACH;;IACD,KAAKF,cAAL,CAAoBrD,OAApB;EACH;;EACDiI,mBAAmB,CAACzI,EAAD,EAAKsF,MAAL,EAAajF,KAAb,EAAoBgL,SAApB,EAA+B;IAC9C,KAAKnB,yBAAL,CAA+B,CAAC,GAAGtM,qBAAqB,CAAC8F,mBAA1B,EAA+C;MAC1E1D,EAD0E;MAE1E2D,QAAQ,EAAE,CAAC,GAAGhG,cAAc,CAAC2N,aAAnB,EAAkChG,MAAlC,EAA0C,CAACjF,KAAK,KAAK,IAAV,IAAkBA,KAAK,KAAK,KAAK,CAAjC,GAAqCA,KAArC,GAA6CnD,eAAe,CAACqO,aAAhB,CAA8BC,mBAA5E,EAAiGhL,OAA3I,EAAoJ6K,SAApJ;IAFgE,CAA/C,CAA/B;EAIH;;EACDxH,cAAc,CAACrD,OAAD,EAAU;IACpB,MAAMiL,QAAQ,GAAG,KAAKxM,iBAAL,CAAuBgK,SAAvB,CAAiClO,GAAjC,CAAqCyF,OAAO,CAACR,EAA7C,CAAjB;;IACA,IAAIyL,QAAJ,EAAc;MACVA,QAAQ,CAACjL,OAAO,CAACmD,QAAT,CAAR;MACA,KAAK1E,iBAAL,CAAuBgK,SAAvB,CAAiCyC,MAAjC,CAAwClL,OAAO,CAACR,EAAhD;IACH;EACJ;;EACD2L,uBAAuB,GAAG;IACtB,MAAMvD,OAAO,GAAG;MACZ9C,MAAM,EAAE9H,YAAY,CAACgJ,UAAb,CAAwBmF,uBADpB;MAEZlF,MAAM,EAAE;QACJnI,OAAO,EAAE,KAAKA,OADV;QAEJC,UAAU,EAAE,KAAKA,UAAL,IAAmB;MAF3B;IAFI,CAAhB;IAOA,MAAM8J,gBAAgB,GAAG,IAAzB;IACA,MAAMrI,EAAE,GAAG,CAAC,GAAG5C,MAAM,CAACkL,cAAX,EAA2B,CAA3B,CAAX;;IACA,MAAMC,MAAM,GAAIlI,KAAD,IAAW;MACtB,KAAKmI,+BAAL,CAAqCxI,EAArC;MACA,KAAKyI,mBAAL,CAAyBzI,EAAzB,EAA6BoI,OAAO,CAAC9C,MAArC,EAA6CjF,KAA7C,EAFsB,CAGtB;MACA;;MACAgI,gBAAgB,KAAK,IAArB,IAA6BA,gBAAgB,KAAK,KAAK,CAAvD,GAA2D,KAAK,CAAhE,GAAoEA,gBAAgB,EAApF;IACH,CAND;;IAOA,MAAMK,OAAO,GAAG,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;MAC7C,IAAI7K,EAAJ;;MACA,KAAKiB,iBAAL,CAAuBgK,SAAvB,CAAiCC,GAAjC,CAAqClJ,EAArC,EAAyC2D,QAAQ,IAAI;QACjD,KAAK9E,EAAL,CAAQ+M,2BAAR,GADiD,CAEjD;QACA;;QACAvD,gBAAgB,KAAK,IAArB,IAA6BA,gBAAgB,KAAK,KAAK,CAAvD,GAA2D,KAAK,CAAhE,GAAoEA,gBAAgB,EAApF;;QACA,IAAI1E,QAAQ,CAACwF,YAAb,EAA2B;UACvB,OAAON,MAAM,CAAC,IAAIzJ,KAAJ,CAAUuE,QAAQ,CAACwF,YAAnB,CAAD,CAAb;QACH;;QACDP,OAAO,CAACjF,QAAD,CAAP;MACH,CATD;MAUA,MAAMkI,SAAS,GAAG,CAAC,CAAC7N,EAAE,GAAG8N,MAAM,KAAK,IAAX,IAAmBA,MAAM,KAAK,KAAK,CAAnC,GAAuC,KAAK,CAA5C,GAAgDA,MAAM,CAACC,SAA7D,MAA4E,IAA5E,IAAoF/N,EAAE,KAAK,KAAK,CAAhG,GAAoG,KAAK,CAAzG,GAA6GA,EAAE,CAAC6N,SAAjH,KAA+H,IAAjJ;;MACA,IAAIA,SAAS,IACT,iEAAiEG,IAAjE,CAAsEH,SAAtE,CADJ,EACsF;QAClF,IAAIlB,QAAJ;;QACA,IAAI;UACA,IAAI,CAAC,GAAGvN,MAAM,CAAC6O,UAAX,OAA4BH,MAAM,CAACI,GAAvC,EAA4C;YACxCvB,QAAQ,GAAGmB,MAAM,CAACI,GAAP,CAAWvB,QAAtB;UACH,CAFD,MAGK;YACDA,QAAQ,GAAGmB,MAAM,CAACnB,QAAlB;UACH;QACJ,CAPD,CAQA,OAAOwB,CAAP,EAAU;UACNxB,QAAQ,GAAGmB,MAAM,CAACnB,QAAlB;QACH;;QACDA,QAAQ,CAACyB,IAAT,GAAiB,6CAA4CC,kBAAkB,CAAC1B,QAAQ,CAACyB,IAAV,CAAgB,EAA/F;QACA;MACH;;MACD,IAAI,KAAKvN,EAAL,CAAQyN,sBAAR,EAAJ,EAAsC;QAClC,MAAMC,UAAU,GAAIC,QAAD,IAAc;UAC7B,KAAKtC,yBAAL,CAA+B,CAAC,GAAGtM,qBAAqB,CAAC8F,mBAA1B,EAA+C;YAC1E1D,EAD0E;YAE1E2D,QAAQ,EAAE,CAAC,GAAGhG,cAAc,CAACiG,+BAAnB,EAAoD4I,QAApD;UAFgE,CAA/C,CAA/B;QAIH,CALD;;QAMA,KAAK3N,EAAL,CAAQ8M,uBAAR,CAAgC;UAC5B5C,QAAQ,EAAER,MADkB;UAE5BgE;QAF4B,CAAhC;MAIH,CAXD,MAYK;QACD;QACA,MAAMnH,GAAG,GAAGvI,gBAAgB,CAAC4P,SAAjB,CAA2BC,QAA3B,CAAoCC,mBAApC,CAAwD,mCAAxD,CAAZ;QACA,KAAK9N,EAAL,CAAQ8M,uBAAR,CAAgC;UAC5B5C,QAAQ,EAAE,MAAMR,MAAM,CAACnD,GAAD;QADM,CAAhC;MAGH;;MACD1I,cAAc,CAAC0G,yBAAf,CAAyC1D,GAAzC,CAA6CM,EAA7C;;MACA,IAAI,CAAC,KAAKnB,EAAL,CAAQyN,sBAAR,EAAD,IAAqC,CAAC,KAAKzN,EAAL,CAAQqG,YAAR,EAA1C,EAAkE;QAC9D,KAAKmE,uBAAL,CAA6BrJ,EAA7B,EAAiCoI,OAAjC;MACH;IACJ,CArDe,CAAhB;IAsDA,OAAO;MAAEM,OAAF;MAAWH;IAAX,CAAP;EACH;;EACDqE,cAAc,CAACC,eAAD,EAAkB;IAC5B,MAAMzE,OAAO,GAAG;MACZ9C,MAAM,EAAE9H,YAAY,CAACgJ,UAAb,CAAwBoG,cADpB;MAEZnG,MAAM,EAAE;QACJoG;MADI;IAFI,CAAhB;IAMA,MAAM7M,EAAE,GAAG,CAAC,GAAG5C,MAAM,CAACkL,cAAX,EAA2B,CAA3B,CAAX;;IACA,MAAMC,MAAM,GAAIlI,KAAD,IAAW;MACtB,KAAKmI,+BAAL,CAAqCxI,EAArC;MACA,KAAKyI,mBAAL,CAAyBzI,EAAzB,EAA6BoI,OAAO,CAAC9C,MAArC,EAA6CjF,KAA7C;IACH,CAHD;;IAIA,MAAMqI,OAAO,GAAG,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;MAC7C,KAAK5J,iBAAL,CAAuBgK,SAAvB,CAAiCC,GAAjC,CAAqClJ,EAArC,EAAyC2D,QAAQ,IAAI;QACjD,IAAIA,QAAQ,CAACwF,YAAb,EAA2B;UACvB,OAAON,MAAM,CAAC,IAAIzJ,KAAJ,CAAUuE,QAAQ,CAACwF,YAAnB,CAAD,CAAb;QACH;;QACDP,OAAO,CAACjF,QAAD,CAAP;MACH,CALD;;MAMA,MAAMmJ,OAAO,GAAIC,MAAD,IAAY;QACxB,KAAK7C,yBAAL,CAA+B,CAAC,GAAGtM,qBAAqB,CAAC8F,mBAA1B,EAA+C;UAC1E1D,EAD0E;UAE1E2D,QAAQ,EAAE,CAAC,GAAGhG,cAAc,CAACqP,sBAAnB,EAA2C7P,OAAO,CAAC8P,YAAR,CAAqBC,UAAhE;QAFgE,CAA/C,CAA/B;MAIH,CALD;;MAMA,MAAMC,OAAO,GAAIC,mBAAD,IAAyB;QACrC,KAAKlD,yBAAL,CAA+B,CAAC,GAAGtM,qBAAqB,CAAC8F,mBAA1B,EAA+C;UAC1E1D,EAD0E;UAE1E2D,QAAQ,EAAE,CAAC,GAAGhG,cAAc,CAACqP,sBAAnB,EAA2CI,mBAA3C;QAFgE,CAA/C,CAA/B;MAIH,CALD;;MAMA,IAAI,KAAKvO,EAAL,CAAQ+N,cAAZ,EACI,KAAK/N,EAAL,CAAQ+N,cAAR,CAAuB;QACnBS,SAAS,EAAEF,OADQ;QAEnBpE,QAAQ,EAAE+D,OAFS;QAGnBD;MAHmB,CAAvB;IAKP,CAzBe,CAAhB;IA0BA,OAAO;MAAEtE,MAAF;MAAUG;IAAV,CAAP;EACH;;EACD4E,UAAU,CAACC,IAAD,EAAOnH,OAAP,EAAgBoH,MAAhB,EAAwBC,QAAxB,EAAkCC,KAAlC,EAAyC/N,OAAzC,EAAkD;IACxD,MAAMyI,OAAO,GAAG;MACZ9C,MAAM,EAAE9H,YAAY,CAACgJ,UAAb,CAAwB8G,UADpB;MAEZ7G,MAAM,EAAE;QACJ8G,IADI;QAEJxP,OAAO,EAAE;UACLqI,OADK;UAELoH,MAFK;UAGLC,QAHK;UAILC;QAJK,CAFL;QAQJ/N;MARI;IAFI,CAAhB;IAaA,IAAI0I,gBAAgB,GAAG,IAAvB;IACA,MAAMrI,EAAE,GAAG,CAAC,GAAG5C,MAAM,CAACkL,cAAX,EAA2B,CAA3B,CAAX;;IACA,MAAMC,MAAM,GAAIlI,KAAD,IAAW;MACtB,KAAKmI,+BAAL,CAAqCxI,EAArC;MACA,KAAKyI,mBAAL,CAAyBzI,EAAzB,EAA6BoI,OAAO,CAAC9C,MAArC,EAA6CjF,KAA7C;MACAgI,gBAAgB,KAAK,IAArB,IAA6BA,gBAAgB,KAAK,KAAK,CAAvD,GAA2D,KAAK,CAAhE,GAAoEA,gBAAgB,EAApF;IACH,CAJD;;IAKA,IAAI,CAAC,KAAKxJ,EAAL,CAAQ8O,gBAAR,EAAL,EAAiC;MAC7BtF,gBAAgB,GAAG,KAAKxJ,EAAL,CAAQiK,cAAR,CAAuB;QACtCxH,oBAAoB,EAAE,KAAKA,oBADW;QAEtCyH,QAAQ,EAAER,MAF4B;QAGtCS,iBAAiB,EAAE,KAAK9G,cAHc,CAGE;;MAHF,CAAvB,CAAnB;IAKH;;IACD,MAAMwG,OAAO,GAAG,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;MAC7C,KAAK5J,iBAAL,CAAuBgK,SAAvB,CAAiCC,GAAjC,CAAqClJ,EAArC,EAAyC2D,QAAQ,IAAI;QACjD0E,gBAAgB,KAAK,IAArB,IAA6BA,gBAAgB,KAAK,KAAK,CAAvD,GAA2D,KAAK,CAAhE,GAAoEA,gBAAgB,EAApF;;QACA,IAAI1E,QAAQ,CAACwF,YAAb,EAA2B;UACvB,OAAON,MAAM,CAAC,IAAIzJ,KAAJ,CAAUuE,QAAQ,CAACwF,YAAnB,CAAD,CAAb;QACH;;QACDP,OAAO,CAACjF,QAAD,CAAP;MACH,CAND;;MAOA,MAAMmJ,OAAO,GAAIC,MAAD,IAAY;QACxB,KAAK7C,yBAAL,CAA+B,CAAC,GAAGtM,qBAAqB,CAAC8F,mBAA1B,EAA+C;UAC1E1D,EAD0E;UAE1E2D,QAAQ,EAAE,CAAC,GAAGhG,cAAc,CAACiQ,iBAAnB,EAAsC,KAAtC;QAFgE,CAA/C,CAA/B;MAIH,CALD;;MAMA,MAAMT,OAAO,GAAG,MAAM;QAClB,KAAKjD,yBAAL,CAA+B,CAAC,GAAGtM,qBAAqB,CAAC8F,mBAA1B,EAA+C;UAC1E1D,EAD0E;UAE1E2D,QAAQ,EAAE,CAAC,GAAGhG,cAAc,CAACiQ,iBAAnB,EAAsC,IAAtC;QAFgE,CAA/C,CAA/B;MAIH,CALD;;MAMA,IAAI,KAAK/O,EAAL,CAAQ8O,gBAAR,EAAJ,EAAgC;QAC5B,KAAK9O,EAAL,CAAQyO,UAAR,CAAmB;UACfD,SAAS,EAAEF,OADI;UAEfpE,QAAQ,EAAE+D,OAFK;UAGfS,IAHe;UAIfnH,OAJe;UAKfoH,MALe;UAMfC,QANe;UAOfC,KAPe;UAQf/N;QARe,CAAnB;MAUH;;MACD,IAAI,CAAC,KAAKd,EAAL,CAAQ8O,gBAAR,EAAD,IAA+B,CAAC,KAAK9O,EAAL,CAAQqG,YAAR,EAApC,EAA4D;QACxD,KAAKmE,uBAAL,CAA6BrJ,EAA7B,EAAiCoI,OAAjC;MACH;IACJ,CAnCe,CAAhB;IAoCA,OAAO;MAAEG,MAAF;MAAUG;IAAV,CAAP;EACH;;EACDmF,gBAAgB,CAAClO,OAAD,EAAUmO,OAAV,EAAmBC,QAAnB,EAA6BC,iBAA7B,EAAgDC,SAAhD,EAA2DC,cAA3D,EAA2E;IACvF,MAAM9F,OAAO,GAAG;MACZ9C,MAAM,EAAE9H,YAAY,CAACgJ,UAAb,CAAwBqH,gBADpB;MAEZpH,MAAM,EAAE;QACJ9G,OADI;QAEJmO,OAFI;QAGJE,iBAHI;QAIJC,SAJI;QAKJF,QALI;QAMJG;MANI;IAFI,CAAhB;IAWA,IAAI7F,gBAAgB,GAAG,IAAvB;IACA,MAAMrI,EAAE,GAAG,CAAC,GAAG5C,MAAM,CAACkL,cAAX,EAA2B,CAA3B,CAAX;;IACA,MAAMC,MAAM,GAAIlI,KAAD,IAAW;MACtB,KAAKmI,+BAAL,CAAqCxI,EAArC;MACA,KAAKyI,mBAAL,CAAyBzI,EAAzB,EAA6BoI,OAAO,CAAC9C,MAArC,EAA6CjF,KAA7C;MACAgI,gBAAgB,KAAK,IAArB,IAA6BA,gBAAgB,KAAK,KAAK,CAAvD,GAA2D,KAAK,CAAhE,GAAoEA,gBAAgB,EAApF;IACH,CAJD;;IAKA,IAAI,CAAC,KAAKxJ,EAAL,CAAQsP,sBAAR,CAA+BxO,OAA/B,CAAL,EAA8C;MAC1C0I,gBAAgB,GAAG,KAAKxJ,EAAL,CAAQiK,cAAR,CAAuB;QACtCxH,oBAAoB,EAAE,KAAKA,oBADW;QAEtCyH,QAAQ,EAAER,MAF4B;QAGtCS,iBAAiB,EAAE,KAAK9G,cAHc,CAGE;;MAHF,CAAvB,CAAnB;IAKH;;IACD,MAAMwG,OAAO,GAAG,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;MAC7C,KAAK5J,iBAAL,CAAuBgK,SAAvB,CAAiCC,GAAjC,CAAqClJ,EAArC,EAAyC2D,QAAQ,IAAI;QACjD0E,gBAAgB,KAAK,IAArB,IAA6BA,gBAAgB,KAAK,KAAK,CAAvD,GAA2D,KAAK,CAAhE,GAAoEA,gBAAgB,EAApF;;QACA,IAAI1E,QAAQ,CAACwF,YAAb,EAA2B;UACvB,OAAON,MAAM,CAAC,IAAIzJ,KAAJ,CAAUuE,QAAQ,CAACwF,YAAnB,CAAD,CAAb;QACH;;QACDP,OAAO,CAACjF,QAAD,CAAP;MACH,CAND;;MAOA,MAAMmJ,OAAO,GAAIC,MAAD,IAAY;QACxB,KAAK7C,yBAAL,CAA+B,CAAC,GAAGtM,qBAAqB,CAAC8F,mBAA1B,EAA+C;UAC1E1D,EAD0E;UAE1E2D,QAAQ,EAAE,CAAC,GAAGhG,cAAc,CAACyQ,wBAAnB,EAA6C;YACnDC,UAAU,EAAE,KADuC;YAEnDC,MAAM,EAAE;UAF2C,CAA7C;QAFgE,CAA/C,CAA/B;MAOH,CARD;;MASA,MAAMnB,OAAO,GAAImB,MAAD,IAAY;QACxB,KAAKpE,yBAAL,CAA+B,CAAC,GAAGtM,qBAAqB,CAAC8F,mBAA1B,EAA+C;UAC1E1D,EAD0E;UAE1E2D,QAAQ,EAAE,CAAC,GAAGhG,cAAc,CAACyQ,wBAAnB,EAA6C;YAAEC,UAAU,EAAE,IAAd;YAAoBC;UAApB,CAA7C;QAFgE,CAA/C,CAA/B;MAIH,CALD;;MAMA,IAAI,KAAKzP,EAAL,CAAQsP,sBAAR,CAA+BxO,OAA/B,CAAJ,EAA6C;QACzC,KAAKd,EAAL,CAAQgP,gBAAR,CAAyB;UACrB9E,QAAQ,EAAE+D,OADW;UAErBO,SAAS,EAAEF,OAFU;UAGrBxN,OAAO,EAAEyI,OAAO,CAAC3B,MAAR,CAAe9G,OAHH;UAIrBmO,OAAO,EAAE1F,OAAO,CAAC3B,MAAR,CAAeqH,OAJH;UAKrBE,iBAAiB,EAAE5F,OAAO,CAAC3B,MAAR,CAAeuH,iBALb;UAMrBC,SAAS,EAAE7F,OAAO,CAAC3B,MAAR,CAAewH,SANL;UAOrBF,QAAQ,EAAE3F,OAAO,CAAC3B,MAAR,CAAesH,QAPJ;UAQrBG,cAAc,EAAE9F,OAAO,CAAC3B,MAAR,CAAeyH;QARV,CAAzB;MAUH;;MACD,IAAI,CAAC,KAAKrP,EAAL,CAAQsP,sBAAR,CAA+BxO,OAA/B,CAAD,IAA4C,CAAC,KAAKd,EAAL,CAAQqG,YAAR,EAAjD,EAAyE;QACrE,KAAKmE,uBAAL,CAA6BrJ,EAA7B,EAAiCoI,OAAjC;MACH;IACJ,CAtCe,CAAhB;IAuCA,OAAO;MAAEM,OAAF;MAAWH;IAAX,CAAP;EACH;;EACDgG,mBAAmB,CAAC5O,OAAD,EAAUyG,OAAV,EAAmB;IAClC,MAAMgC,OAAO,GAAG;MACZ9C,MAAM,EAAE9H,YAAY,CAACgJ,UAAb,CAAwB+H,mBADpB;MAEZ9H,MAAM,EAAEnM,MAAM,CAACwJ,MAAP,CAAc;QAAEnE;MAAF,CAAd,EAA2B;QAAEyG;MAAF,CAA3B;IAFI,CAAhB;IAIA,MAAMpG,EAAE,GAAG,CAAC,GAAG5C,MAAM,CAACkL,cAAX,EAA2B,CAA3B,CAAX;;IACA,MAAMC,MAAM,GAAIlI,KAAD,IAAW;MACtB,KAAKmI,+BAAL,CAAqCxI,EAArC;MACA,KAAKyI,mBAAL,CAAyBzI,EAAzB,EAA6BoI,OAAO,CAAC9C,MAArC,EAA6CjF,KAA7C;IACH,CAHD;;IAIA,MAAMqI,OAAO,GAAG,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;MAC7C,KAAK5J,iBAAL,CAAuBgK,SAAvB,CAAiCC,GAAjC,CAAqClJ,EAArC,EAAyC2D,QAAQ,IAAI;QACjD,IAAIA,QAAQ,CAACwF,YAAT,IAAyBxF,QAAQ,CAAC0H,SAAtC,EAAiD;UAC7C,OAAOxC,MAAM,CAAChM,gBAAgB,CAAC4P,SAAjB,CAA2BC,QAA3B,CAAoC8B,MAApC,CAA2C;YACrDC,IAAI,EAAE9K,QAAQ,CAAC0H,SADsC;YAErD7K,OAAO,EAAG;UAF2C,CAA3C,CAAD,CAAb;QAIH,CALD,MAMK,IAAImD,QAAQ,CAACwF,YAAb,EAA2B;UAC5B,OAAON,MAAM,CAAC,IAAIzJ,KAAJ,CAAUuE,QAAQ,CAACwF,YAAnB,CAAD,CAAb;QACH;;QACDP,OAAO,CAACjF,QAAD,CAAP;MACH,CAXD;;MAYA,MAAMmJ,OAAO,GAAIzM,KAAD,IAAW;QACvB,IAAI,OAAOA,KAAP,KAAiB,QAArB,EAA+B;UAC3B;UACA,MAAMgL,SAAS,GAAGhL,KAAlB;UACA,KAAK6J,yBAAL,CAA+B,CAAC,GAAGtM,qBAAqB,CAAC8F,mBAA1B,EAA+C;YAC1E1D,EAD0E;YAE1E2D,QAAQ,EAAE,CAAC,GAAGhG,cAAc,CAAC2N,aAAnB,EAAkC9N,YAAY,CAACgJ,UAAb,CAAwB+H,mBAA1D,EAA+ErR,eAAe,CAACqO,aAAhB,CAA8BmD,qCAA9B,CAAoElO,OAAnJ,EAA4J6K,SAA5J;UAFgE,CAA/C,CAA/B;QAIH,CAPD,MAQK,IAAIhL,KAAK,YAAYnD,eAAe,CAACqO,aAArC,EAAoD;UACrD,KAAK9C,mBAAL,CAAyBzI,EAAzB,EAA6BxC,YAAY,CAACgJ,UAAb,CAAwB+H,mBAArD,EAA0ElO,KAA1E,EAAiFA,KAAK,CAACgL,SAAvF;QACH,CAFI,MAGA;UACD,KAAKnB,yBAAL,CAA+B,CAAC,GAAGtM,qBAAqB,CAAC8F,mBAA1B,EAA+C;YAC1E1D,EAD0E;YAE1E2D,QAAQ,EAAE,CAAC,GAAGhG,cAAc,CAACgR,2BAAnB,EAAgD;cACtDN,UAAU,EAAE,KAD0C;cAEtDC,MAAM,EAAE;YAF8C,CAAhD;UAFgE,CAA/C,CAA/B;QAOH;MACJ,CArBD;;MAsBA,MAAMnB,OAAO,GAAImB,MAAD,IAAY;QACxB,KAAKpE,yBAAL,CAA+B,CAAC,GAAGtM,qBAAqB,CAAC8F,mBAA1B,EAA+C;UAC1E1D,EAD0E;UAE1E2D,QAAQ,EAAE,CAAC,GAAGhG,cAAc,CAACgR,2BAAnB,EAAgD;YACtDN,UAAU,EAAE,IAD0C;YAEtDC;UAFsD,CAAhD;QAFgE,CAA/C,CAA/B;MAOH,CARD;;MASA,KAAKzP,EAAL,CAAQ0P,mBAAR,CAA4B;QACxBxF,QAAQ,EAAE+D,OADc;QAExBO,SAAS,EAAEF,OAFa;QAGxBxN,OAAO,EAAEyI,OAAO,CAAC3B,MAAR,CAAe9G,OAHA;QAIxByG,OAAO,EAAEgC,OAAO,CAAC3B,MAAR,CAAeL;MAJA,CAA5B;;MAMA,IAAI,CAAC,KAAKvH,EAAL,CAAQ+P,yBAAR,EAAD,IAAwC,CAAC,KAAK/P,EAAL,CAAQqG,YAAR,EAA7C,EAAqE;QACjE,KAAKmE,uBAAL,CAA6BrJ,EAA7B,EAAiCoI,OAAjC;MACH;IACJ,CArDe,CAAhB;IAsDA,OAAO;MAAEM,OAAF;MAAWH;IAAX,CAAP;EACH;;EACD4F,sBAAsB,CAACxO,OAAD,EAAU;IAC5B,OAAO,KAAKd,EAAL,CAAQsP,sBAAR,CAA+BxO,OAA/B,CAAP;EACH;;EACDgC,gBAAgB,GAAG;IACf,OAAOrE,SAAS,CAACsC,OAAV,CAAkBgG,IAAlB,CAAuB,KAAK5G,QAAL,CAAcgB,EAArC,CAAP;EACH;;EACDoJ,qBAAqB,CAACpJ,EAAD,EAAKoI,OAAL,EAAc;IAC/B,MAAM0E,OAAO,GAAIzM,KAAD,IAAW;MACvB,KAAKoI,mBAAL,CAAyBzI,EAAzB,EAA6BoI,OAAO,CAAC9C,MAArC,EAA6CjF,KAA7C;IACH,CAFD;;IAGA,MAAMwO,SAAS,GAAIlL,QAAD,IAAc;MAC5B,KAAKuG,yBAAL,CAA+B,CAAC,GAAGtM,qBAAqB,CAAC8F,mBAA1B,EAA+C;QAC1E1D,EAD0E;QAE1E2D;MAF0E,CAA/C,CAA/B;IAIH,CALD;;IAMA,QAAQyE,OAAO,CAAC9C,MAAhB;MACI,KAAK9H,YAAY,CAACgJ,UAAb,CAAwBL,mBAA7B;QACI,KAAKtH,EAAL,CAAQsH,mBAAR,CAA4B;UACxBiC,OADwB;UAExByG,SAFwB;UAGxB9F,QAAQ,EAAE+D;QAHc,CAA5B;QAKA;;MACJ,KAAKtP,YAAY,CAACgJ,UAAb,CAAwBK,uBAA7B;QACI,KAAKhI,EAAL,CAAQgI,uBAAR,CAAgC;UAC5BuB,OAD4B;UAE5ByG,SAF4B;UAG5B9F,QAAQ,EAAE+D;QAHkB,CAAhC;QAKA;;MACJ,KAAKtP,YAAY,CAACgJ,UAAb,CAAwBkB,yBAA7B;QACI,KAAK7I,EAAL,CAAQ6I,yBAAR,CAAkC;UAC9BU,OAD8B;UAE9ByG,SAF8B;UAG9B9F,QAAQ,EAAE+D;QAHoB,CAAlC;QAKA;;MACJ,KAAKtP,YAAY,CAACgJ,UAAb,CAAwBG,gCAA7B;QACI,KAAK9H,EAAL,CAAQ8H,gCAAR,CAAyC;UACrCyB,OADqC;UAErCyG;QAFqC,CAAzC;QAIA;;MACJ;QACI/B,OAAO;;QACP;IA9BR;EAgCH;;EACD1M,sBAAsB,CAAC0O,kBAAD,EAAqB,CAAG;;AAz3B2B;;AA23B7EpS,cAAc,CAAC0G,yBAAf,GAA2C,IAAI2L,GAAJ,EAA3C;;AACA5T,UAAU,CAAC,CACPwB,gBAAgB,CAACqS,OADV,CAAD,EAEPtS,cAAc,CAACL,SAFR,EAEmB,gBAFnB,EAEqC,IAFrC,CAAV;;AAGAlB,UAAU,CAAC,CACPwB,gBAAgB,CAACqS,OADV,CAAD,EAEPtS,cAAc,CAACL,SAFR,EAEmB,qBAFnB,EAE0C,IAF1C,CAAV;;AAGAI,OAAO,CAACC,cAAR,GAAyBA,cAAzB"},"metadata":{},"sourceType":"script"}